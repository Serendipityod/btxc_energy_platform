<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é¡¹ç›®è¥æ”¶ç®¡ç† - å”®ç”µåˆåŒç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#409eff',
                        'primary-hover': '#66b1ff',
                        success: '#67c23a',
                        warning: '#e6a23c',
                        danger: '#f56c6c',
                        info: '#909399',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body { background-color: #f0f2f5; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Sticky Column Styles if needed, currently not used but good for wide tables */
        .sticky-left { position: sticky; left: 0; z-index: 10; background-color: inherit; }

        /* Loading Spinner */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #409eff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table row hover effect enhancement */
        tbody tr:hover td {
            background-color: #f8fafc !important;
        }

        /* Input focus animation */
        input:focus, select:focus {
            transition: all 0.2s ease;
            box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.1);
        }

        /* Button hover animation */
        button {
            transition: all 0.2s ease;
        }

        button:active {
            transform: scale(0.98);
        }
    </style>

    <!-- Import Map for React modules -->
    <script type="importmap">
    {
      "imports": {
        "lucide-react": "https://esm.sh/lucide-react@0.292.0",
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
      }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Search, Plus, Upload, Download, ChevronLeft, ChevronRight, FileText, RefreshCw } from 'lucide-react';

        // --- Types & Mock Data ---

        const STATUS_OPTIONS = ['å¾…æäº¤', 'å·²æäº¤', 'å·²ç¡®è®¤', 'å·²é€€å›'];

        // Mock Data Generator
        const generateData = () => {
            const data = [];
            const depts = ['å¸‚åœºå¼€å‘éƒ¨', 'å·¥ç¨‹æŠ€æœ¯éƒ¨', 'ç»¼åˆèƒ½æºéƒ¨', 'å®¢æˆ·æœåŠ¡ä¸­å¿ƒ'];
            const owners = ['å¹¿è¥¿æŠ•èµ„é›†å›¢', 'å—å®è½¨é“äº¤é€š', 'åæ¶¦æ°´æ³¥', 'æŸ³å·é’¢é“'];
            const types = ['å”®ç”µæœåŠ¡', 'èŠ‚èƒ½æ”¹é€ ', 'å…‰ä¼EPC', 'è¿ç»´æœåŠ¡'];
            const managers = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­'];
            
            for (let i = 1; i <= 20; i++) {
                data.push({
                    id: i,
                    dept: depts[i % 4],
                    code: `PRJ-2025-${String(i).padStart(3, '0')}`,
                    name: `${owners[i % 4]}-${types[i % 4]}é¡¹ç›®-${i}æœŸ`,
                    owner: owners[i % 4],
                    type: types[i % 4],
                    manager: managers[i % 4],
                    category: i % 2 === 0 ? 'ç”µåŠ›äº¤æ˜“' : 'ç»¼åˆèƒ½æº',
                    contractAmount: Math.floor(1000000 + i * 50000).toString(),
                    taxRate: i % 3 === 0 ? '13%' : '6%',
                    margin: (15 + i * 0.5).toFixed(2),

                    // Plan fields
                    planNewRevenue: Math.floor(50000 + i * 2000).toString(),

                    // Common fields
                    procurementProgress: `${30 + i * 2}%`,
                    progressNote: 'æ­£å¸¸æ¨è¿›ä¸­',
                    estRevenue: Math.floor(45000 + i * 2000).toString(),
                    evidence: i % 3 === 0 ? ['acceptance_report.pdf', 'contract.pdf'].slice(0, i % 2 + 1) : [],

                    // Actual fields (mocking some empty for plan stage)
                    actualRevenue: Math.floor(45000 + i * 2000).toString(),
                    actualMargin: (5000 + i * 200).toFixed(2),
                    
                    status: STATUS_OPTIONS[i % 4],
                    approval: i % 4 === 3 ? 'è¯·è¡¥å……éªŒæ”¶å•æ®' : 'åŒæ„',
                    confirmer: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    confirmTime: '2025-05-20 10:00',
                    applicant: '',
                    note: '',
                    isNewlyAdded: false // åˆå§‹æ•°æ®ä¸æ˜¯æ–°æ·»åŠ çš„
                });
            }
            return data;
        };

        // --- Components ---

        const StatusTag = ({ status }) => {
            let colors = '';
            switch (status) {
                case 'å·²ç¡®è®¤':
                    colors = 'bg-green-50 text-green-600 border-green-200';
                    break;
                case 'å¾…æäº¤':
                    colors = 'bg-gray-50 text-gray-500 border-gray-200';
                    break;
                case 'å·²æäº¤':
                    colors = 'bg-blue-50 text-blue-600 border-blue-200';
                    break;
                case 'å·²é€€å›':
                    colors = 'bg-red-50 text-red-500 border-red-200';
                    break;
                default:
                    colors = 'bg-gray-50 text-gray-600 border-gray-200';
            }
            return (
                <span className={`inline-flex items-center justify-center px-2 py-0.5 text-xs font-medium border rounded ${colors}`}>
                    {status}
                </span>
            );
        };

        // Modal Component
        const Modal = ({ isOpen, onClose, title, children, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="fixed inset-0 bg-black/50" onClick={onClose}></div>
                    <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <RefreshCw size={20} />
                            </button>
                        </div>
                        <div className="text-gray-600">
                            {children}
                        </div>
                        {onConfirm ? (
                            <div className="flex justify-end gap-2 mt-6">
                                <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors">
                                    å–æ¶ˆ
                                </button>
                                <button onClick={onConfirm} className="px-4 py-2 text-sm text-white bg-primary rounded hover:bg-primary-hover transition-colors">
                                    ç¡®è®¤
                                </button>
                            </div>
                        ) : (
                            <div className="flex justify-end gap-2 mt-6">
                                <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors">
                                    å–æ¶ˆ
                                </button>
                                <button onClick={onClose} className="px-4 py-2 text-sm text-white bg-primary rounded hover:bg-primary-hover transition-colors">
                                    ç¡®è®¤
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Deadline Setting Modal Component
        const DeadlineModal = ({ isOpen, onClose, onConfirm }) => {
            const [tempDeadline, setTempDeadline] = useState('');

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="fixed inset-0 bg-black/50" onClick={onClose}></div>
                    <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">è®¾ç½®å¡«æŠ¥æˆªæ­¢æ—¶é—´</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <RefreshCw size={20} />
                            </button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm text-gray-600 mb-2">æˆªæ­¢æ—¶é—´</label>
                            <input
                                type="datetime-local"
                                value={tempDeadline}
                                onChange={(e) => setTempDeadline(e.target.value)}
                                className="w-full h-10 px-3 text-sm border border-gray-300 rounded outline-none focus:border-primary"
                            />
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button onClick={() => onConfirm(tempDeadline)} className="px-4 py-2 text-sm text-white bg-primary rounded hover:bg-primary-hover transition-colors">
                                ç¡®è®¤
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Add Project Modal Component
        const AddProjectModal = ({ isOpen, onClose, onAdd, existingData }) => {
            const [selectedProjects, setSelectedProjects] = useState([]);
            const [searchName, setSearchName] = useState('');
            const [searchCode, setSearchCode] = useState('');
            const [searchDept, setSearchDept] = useState('');

            // æ‰€æœ‰å¯é€‰é¡¹ç›®æ¨¡æ¿
            const allProjectTemplates = [
                { id: 1, code: 'PRJ-TEMPLATE-001', name: 'å¹¿è¥¿æŠ•èµ„é›†å›¢å”®ç”µæœåŠ¡é¡¹ç›®', dept: 'å¸‚åœºå¼€å‘éƒ¨', type: 'å”®ç”µæœåŠ¡', owner: 'å¹¿è¥¿æŠ•èµ„é›†å›¢', manager: 'å¼ ä¸‰', category: 'ç”µåŠ›äº¤æ˜“', contractAmount: 1000000, taxRate: '13%', margin: 15 },
                { id: 2, code: 'PRJ-TEMPLATE-002', name: 'å—å®è½¨é“äº¤é€šèŠ‚èƒ½æ”¹é€ é¡¹ç›®', dept: 'å·¥ç¨‹æŠ€æœ¯éƒ¨', type: 'èŠ‚èƒ½æ”¹é€ ', owner: 'å—å®è½¨é“äº¤é€š', manager: 'æå››', category: 'ç»¼åˆèƒ½æº', contractAmount: 1500000, taxRate: '6%', margin: 18 },
                { id: 3, code: 'PRJ-TEMPLATE-003', name: 'åæ¶¦æ°´æ³¥å…‰ä¼EPCé¡¹ç›®', dept: 'ç»¼åˆèƒ½æºéƒ¨', type: 'å…‰ä¼EPC', owner: 'åæ¶¦æ°´æ³¥', manager: 'ç‹äº”', category: 'ç»¼åˆèƒ½æº', contractAmount: 2000000, taxRate: '13%', margin: 20 },
                { id: 4, code: 'PRJ-TEMPLATE-004', name: 'æŸ³å·é’¢é“è¿ç»´æœåŠ¡é¡¹ç›®', dept: 'å®¢æˆ·æœåŠ¡ä¸­å¿ƒ', type: 'è¿ç»´æœåŠ¡', owner: 'æŸ³å·é’¢é“', manager: 'èµµå…­', category: 'ç”µåŠ›äº¤æ˜“', contractAmount: 800000, taxRate: '6%', margin: 12 },
                { id: 5, code: 'PRJ-TEMPLATE-005', name: 'å¹¿è¥¿ç”µç½‘ç”µåŠ›äº¤æ˜“é¡¹ç›®', dept: 'å¸‚åœºå¼€å‘éƒ¨', type: 'å”®ç”µæœåŠ¡', owner: 'å¹¿è¥¿ç”µç½‘', manager: 'å­™ä¸ƒ', category: 'ç”µåŠ›äº¤æ˜“', contractAmount: 1200000, taxRate: '13%', margin: 16 },
                { id: 6, code: 'PRJ-TEMPLATE-006', name: 'å—å®åœ°é“èƒ½æºç®¡ç†é¡¹ç›®', dept: 'å·¥ç¨‹æŠ€æœ¯éƒ¨', type: 'èŠ‚èƒ½æ”¹é€ ', owner: 'å—å®åœ°é“', manager: 'å‘¨å…«', category: 'ç»¼åˆèƒ½æº', contractAmount: 1800000, taxRate: '6%', margin: 19 },
                { id: 7, code: 'PRJ-TEMPLATE-007', name: 'ç‰æŸ´å…‰ä¼å‘ç”µé¡¹ç›®', dept: 'ç»¼åˆèƒ½æºéƒ¨', type: 'å…‰ä¼EPC', owner: 'ç‰æŸ´é›†å›¢', manager: 'å´ä¹', category: 'ç»¼åˆèƒ½æº', contractAmount: 2500000, taxRate: '13%', margin: 22 },
                { id: 8, code: 'PRJ-TEMPLATE-008', name: 'æ¡‚æ—é’¢é“å‚åŒºæ”¹é€ é¡¹ç›®', dept: 'å®¢æˆ·æœåŠ¡ä¸­å¿ƒ', type: 'èŠ‚èƒ½æ”¹é€ ', owner: 'æ¡‚æ—é’¢é“', manager: 'éƒ‘å', category: 'ç»¼åˆèƒ½æº', contractAmount: 1600000, taxRate: '6%', margin: 17 },
            ];

            // è¿‡æ»¤æ‰å·²å­˜åœ¨çš„é¡¹ç›®
            const existingCodes = existingData.map(item => item.code);
            const availableProjects = allProjectTemplates.filter(project =>
                !existingCodes.includes(project.code)
            );

            // æœç´¢è¿‡æ»¤
            const filteredProjects = availableProjects.filter(project => {
                return (
                    (!searchName || project.name.toLowerCase().includes(searchName.toLowerCase())) &&
                    (!searchCode || project.code.toLowerCase().includes(searchCode.toLowerCase())) &&
                    (!searchDept || project.dept.toLowerCase().includes(searchDept.toLowerCase()))
                );
            });

            const handleSelectProject = (projectId) => {
                if (selectedProjects.includes(projectId)) {
                    setSelectedProjects(selectedProjects.filter(id => id !== projectId));
                } else {
                    setSelectedProjects([...selectedProjects, projectId]);
                }
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedProjects(filteredProjects.map(p => p.id));
                } else {
                    setSelectedProjects([]);
                }
            };

            const handleConfirmAdd = () => {
                const projectsToAdd = filteredProjects.filter(p => selectedProjects.includes(p.id));
                onAdd(projectsToAdd);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center">
                    <div className="fixed inset-0 bg-black/50" onClick={onClose}></div>
                    <div className="relative bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 p-6 max-h-[80vh] overflow-hidden flex flex-col">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800">é€‰æ‹©æ–°å¢é¡¹ç›®ï¼ˆå¯å¤šé€‰ï¼‰</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <RefreshCw size={20} />
                            </button>
                        </div>

                        {/* æœç´¢æ  */}
                        <div className="flex items-center gap-4 mb-4 pb-4 border-b border-gray-100">
                            <div className="flex items-center">
                                <label className="text-sm text-gray-600 mr-2">é¡¹ç›®åç§°</label>
                                <input
                                    type="text"
                                    placeholder="æœç´¢é¡¹ç›®åç§°"
                                    className="w-48 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                    value={searchName}
                                    onChange={e => setSearchName(e.target.value)}
                                />
                            </div>
                            <div className="flex items-center">
                                <label className="text-sm text-gray-600 mr-2">é¡¹ç›®ç¼–å·</label>
                                <input
                                    type="text"
                                    placeholder="æœç´¢é¡¹ç›®ç¼–å·"
                                    className="w-40 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                    value={searchCode}
                                    onChange={e => setSearchCode(e.target.value)}
                                />
                            </div>
                            <div className="flex items-center">
                                <label className="text-sm text-gray-600 mr-2">å®æ–½éƒ¨é—¨</label>
                                <input
                                    type="text"
                                    placeholder="æœç´¢å®æ–½éƒ¨é—¨"
                                    className="w-40 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                    value={searchDept}
                                    onChange={e => setSearchDept(e.target.value)}
                                />
                            </div>
                            <div className="ml-auto text-sm text-gray-500">
                                å·²é€‰ <span className="text-primary font-semibold">{selectedProjects.length}</span> ä¸ªé¡¹ç›®
                            </div>
                        </div>

                        {/* é¡¹ç›®åˆ—è¡¨ */}
                        <div className="flex-1 overflow-y-auto custom-scroll mb-4">
                            {filteredProjects.length === 0 ? (
                                <div className="text-center py-20 text-gray-400">
                                    <div className="text-4xl opacity-30 mb-2">ğŸ“‹</div>
                                    <div>æ²¡æœ‰å¯ç”¨çš„é¡¹ç›®</div>
                                    <div className="text-xs mt-1">æ‰€æœ‰é¡¹ç›®æ¨¡æ¿éƒ½å·²è¢«æ·»åŠ </div>
                                </div>
                            ) : (
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-4 py-2 w-10 text-center">
                                                <input
                                                    type="checkbox"
                                                    checked={selectedProjects.length > 0 && selectedProjects.length === filteredProjects.length}
                                                    onChange={handleSelectAll}
                                                    className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"
                                                />
                                            </th>
                                            <th className="px-4 py-2 text-left min-w-[200px]">é¡¹ç›®åç§°</th>
                                            <th className="px-4 py-2 text-left min-w-[140px]">é¡¹ç›®ç¼–å·</th>
                                            <th className="px-4 py-2 text-left">å®æ–½éƒ¨é—¨</th>
                                            <th className="px-4 py-2 text-left">é¡¹ç›®ç±»å‹</th>
                                            <th className="px-4 py-2 text-left">ä¸šä¸»å•ä½</th>
                                            <th className="px-4 py-2 text-left">é¡¹ç›®ç»ç†</th>
                                            <th className="px-4 py-2 text-left">ä¸šåŠ¡åˆ†ç±»</th>
                                            <th className="px-4 py-2 text-right">å«ç¨åˆåŒé‡‘é¢(å…ƒ)</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {filteredProjects.map(project => (
                                            <tr
                                                key={project.id}
                                                className={`hover:bg-gray-50 ${selectedProjects.includes(project.id) ? 'bg-blue-50' : ''}`}
                                            >
                                                <td className="px-4 py-2 text-center">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedProjects.includes(project.id)}
                                                        onChange={() => handleSelectProject(project.id)}
                                                        className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"
                                                    />
                                                </td>
                                                <td className="px-4 py-2 text-gray-800">{project.name}</td>
                                                <td className="px-4 py-2 text-gray-600 font-mono text-xs">{project.code}</td>
                                                <td className="px-4 py-2">{project.dept}</td>
                                                <td className="px-4 py-2">{project.type}</td>
                                                <td className="px-4 py-2">{project.owner}</td>
                                                <td className="px-4 py-2">{project.manager}</td>
                                                <td className="px-4 py-2">{project.category}</td>
                                                <td className="px-4 py-2 text-right font-mono">{Number(project.contractAmount).toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>

                        {/* åº•éƒ¨æŒ‰é’® */}
                        <div className="flex justify-end gap-2 pt-4 border-t border-gray-100">
                            <button
                                onClick={onClose}
                                className="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors"
                            >
                                å–æ¶ˆ
                            </button>
                            <button
                                onClick={handleConfirmAdd}
                                disabled={selectedProjects.length === 0}
                                className="px-4 py-2 text-sm text-white bg-primary rounded hover:bg-primary-hover transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                ç¡®è®¤æ·»åŠ  ({selectedProjects.length})
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // å®¡æ‰¹å¤„ç†å¼¹çª—ç»„ä»¶
            const ApprovalModal = ({ isOpen, onClose, item, onApprove, onReject }) => {
                const [actualRevenue, setActualRevenue] = useState(item?.actualRevenue || '');
                const [actualMargin, setActualMargin] = useState(item?.actualMargin || '');
                const [approvalNote, setApprovalNote] = useState('');
                const [selectedFiles, setSelectedFiles] = useState(item?.evidence || []);

                if (!isOpen || !item) return null;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center">
                        <div className="fixed inset-0 bg-black/50" onClick={onClose}></div>
                        <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">è¥æ”¶å®¡æ‰¹å¤„ç†</h3>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                    <RefreshCw size={20} />
                                </button>
                            </div>
                            
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <label className="block text-gray-600 mb-1">é¡¹ç›®åç§°</label>
                                        <div className="text-gray-800 font-medium">{item.name}</div>
                                    </div>
                                    <div>
                                        <label className="block text-gray-600 mb-1">æäº¤äºº</label>
                                        <div className="text-gray-800">{item.confirmer || 'èƒ¡æ•'}</div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <label className="block text-gray-600 mb-1">è®¡åˆ’ç¡®è®¤è¥æ”¶ï¼ˆå…ƒï¼‰</label>
                                        <div className="text-gray-800 font-mono">{formatNumber(item.planNewRevenue)}</div>
                                    </div>
                                    <div>
                                        <label className="block text-gray-600 mb-1">æ‹Ÿç”³è¯·ç¡®è®¤è¥æ”¶ï¼ˆå…ƒï¼‰</label>
                                        <div className="text-gray-800 font-mono">{formatNumber(item.estRevenue)}</div>
                                    </div>
                                </div>
                                
                                <div className="text-sm">
                                    <label className="block text-gray-600 mb-1">è¯æ˜ææ–™</label>
                                    <div className="space-y-1">
                                        {selectedFiles.length > 0 ? (
                                            selectedFiles.map((file, index) => (
                                                <div key={index} className="text-blue-600 hover:underline cursor-pointer">
                                                    {file}
                                                </div>
                                            ))
                                        ) : (
                                            <span className="text-gray-400 text-xs">æš‚æ— ææ–™</span>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="text-sm">
                                    <label className="block text-gray-600 mb-1">*å®é™…ç¡®è®¤è¥æ”¶ï¼ˆå…ƒï¼‰</label>
                                    <input
                                        type="text"
                                        value={actualRevenue}
                                        onChange={(e) => setActualRevenue(e.target.value)}
                                        className="w-full h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary"
                                        placeholder="è¯·è¾“å…¥é‡‘é¢"
                                    />
                                </div>
                                
                                <div className="text-sm">
                                    <label className="block text-gray-600 mb-1">å®é™…ç¡®è®¤æ¯›åˆ©ï¼ˆå…ƒï¼‰</label>
                                    <input
                                        type="text"
                                        value={actualMargin}
                                        onChange={(e) => setActualMargin(e.target.value)}
                                        className="w-full h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary"
                                        placeholder="è¯·è¾“å…¥é‡‘é¢"
                                    />
                                </div>
                                
                                <div className="text-sm">
                                    <label className="block text-gray-600 mb-1">å®¡æ‰¹æ„è§</label>
                                    <textarea
                                        value={approvalNote}
                                        onChange={(e) => setApprovalNote(e.target.value)}
                                        className="w-full h-20 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary resize-none"
                                        placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§"
                                    />
                                </div>
                            </div>
                            
                            <div className="flex justify-end gap-2 mt-6">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200 transition-colors"
                                >
                                    è¿”å›
                                </button>
                                <button
                                    onClick={() => onApprove(item.id, actualRevenue, actualMargin, approvalNote)}
                                    className="px-4 py-2 text-sm text-white bg-primary rounded hover:bg-primary-hover transition-colors"
                                >
                                    ç¡®è®¤
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

        // --- Main App Component ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('plan'); // 'plan' or 'actual'
            const [data, setData] = useState([]);
            const [planData, setPlanData] = useState([]); // è®¡åˆ’è¥æ”¶æ•°æ®
            const [filters, setFilters] = useState({
                name: '',
                code: '',
                manager: '',
                dept: '',
                revenueType: 'plan', // 'plan', 'actual', 'confirmed'
                revenueMin: '',
                revenueMax: ''
            });
            const [pagination, setPagination] = useState({ current: 1, size: 10 });
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [modalOpen, setModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState('');
            const [addModalOpen, setAddModalOpen] = useState(false);
            const [selectedRows, setSelectedRows] = useState([]);
            const [countdown, setCountdown] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
            const [deadline, setDeadline] = useState(new Date('2025-12-31T23:59:59')); // å¡«æŠ¥æˆªæ­¢æ—¶é—´
            const [isEditing, setIsEditing] = useState(false); // å…¨å±€ç¼–è¾‘çŠ¶æ€
            const [editingData, setEditingData] = useState([]); // ç¼–è¾‘æ—¶çš„ä¸´æ—¶æ•°æ®
            const [draggedIndex, setDraggedIndex] = useState(null); // æ‹–æ‹½çš„ç´¢å¼•
            const [isFinancialUser, setIsFinancialUser] = useState(false); // æ˜¯å¦ä¸ºè´¢åŠ¡äººå‘˜
            const [approvalModalOpen, setApprovalModalOpen] = useState(false); // å®¡æ‰¹å¼¹çª—
            const [selectedApprovalItem, setSelectedApprovalItem] = useState(null); // é€‰ä¸­çš„å®¡æ‰¹é¡¹ç›®

            // ç®¡ç†åŠŸèƒ½çŠ¶æ€
            const [isFillingOpen, setIsFillingOpen] = useState(false); // æ˜¯å¦å¼€å¯å¡«æŠ¥
            const [hasOpenedBefore, setHasOpenedBefore] = useState(false); // æ˜¯å¦æ›¾ç»å¼€å¯è¿‡å¡«æŠ¥
            const [deadlineModalOpen, setDeadlineModalOpen] = useState(false); // æˆªæ­¢æ—¶é—´è®¾ç½®å¼¹çª—
            const [newDeadline, setNewDeadline] = useState(''); // æ–°çš„æˆªæ­¢æ—¶é—´

            // å¹´æœˆé€‰æ‹©
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            const [selectedYear, setSelectedYear] = useState(currentYear);
            const [selectedMonth, setSelectedMonth] = useState(currentMonth);

            // è·å–å½“æœˆå¡«æŠ¥æˆªæ­¢æ—¥æœŸï¼ˆå‡è®¾æ¯æœˆ25æ—¥ä¸ºæˆªæ­¢æ—¥ï¼‰
            const getMonthDeadline = (year, month) => {
                return new Date(year, month, 25, 23, 59, 59);
            };

            // å¼€å¯å¡«æŠ¥
            const handleOpenFilling = () => {
                setDeadlineModalOpen(true);
            };

            // å…³é—­å¡«æŠ¥
            const handleCloseFilling = () => {
                if (confirm('ç¡®å®šè¦å…³é—­å¡«æŠ¥å—ï¼Ÿå…³é—­åå°†ç¦æ­¢ç¼–è¾‘ã€æ–°å¢å’Œåˆ é™¤æ“ä½œï¼Œå½“å‰æ—¶é—´å°†ä½œä¸ºæˆªæ­¢æ—¶é—´ã€‚')) {
                    setDeadline(new Date());
                    setIsFillingOpen(false);
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘æ¨¡å¼ï¼Œé€€å‡ºç¼–è¾‘æ¨¡å¼
                    if (isEditing) {
                        setIsEditing(false);
                        setEditingData([]);
                    }
                    setModalContent('å¡«æŠ¥å·²å…³é—­ï¼');
                    setModalOpen(true);
                }
            };

            // ç¡®è®¤è®¾ç½®æˆªæ­¢æ—¶é—´
            const handleConfirmDeadline = () => {
                const deadlineDate = new Date(newDeadline);
                if (isNaN(deadlineDate.getTime())) {
                    setModalContent('è¯·è¾“å…¥æœ‰æ•ˆçš„æˆªæ­¢æ—¶é—´ï¼');
                    setModalOpen(true);
                    return;
                }
                setDeadline(deadlineDate);
                setIsFillingOpen(true);
                setHasOpenedBefore(true);
                setDeadlineModalOpen(false);
                setModalContent('å¡«æŠ¥å·²å¼€å¯ï¼');
                setModalOpen(true);
            };

            useEffect(() => {
                // Simulate API load
                setTimeout(() => {
                    const initialData = generateData();
                    setData(initialData);
                    setPlanData(initialData);
                    setLoading(false);
                }, 500);
            }, []);

            // Countdown timer
            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const currentMonthDeadline = getMonthDeadline(selectedYear, selectedMonth);
                    const diff = currentMonthDeadline - now;

                    if (diff > 0) {
                        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                        setCountdown({ days, hours, minutes, seconds });
                    } else {
                        setCountdown({ days: 0, hours: 0, minutes: 0, seconds: 0 });
                    }
                }, 1000);

                return () => clearInterval(timer);
            }, [selectedYear, selectedMonth]);

            // Filtering
            const filteredData = useMemo(() => {
                return data.filter(item => {
                    let revenueFilter = true;
                    if (filters.revenueType && (filters.revenueMin || filters.revenueMax)) {
                        const revenueValue = Number(filters.revenueType === 'plan' ? item.planNewRevenue
                            : filters.revenueType === 'actual' ? item.actualRevenue
                            : item.actualRevenue);
                        const min = filters.revenueMin ? Number(filters.revenueMin) : 0;
                        const max = filters.revenueMax ? Number(filters.revenueMax) : Infinity;
                        revenueFilter = revenueValue >= min && revenueValue <= max;
                    }

                    return (
                        (!filters.name || item.name.toLowerCase().includes(filters.name.toLowerCase())) &&
                        (!filters.code || item.code.toLowerCase().includes(filters.code.toLowerCase())) &&
                        (!filters.manager || item.manager.includes(filters.manager)) &&
                        (!filters.dept || item.dept.includes(filters.dept)) &&
                        revenueFilter
                    );
                });
            }, [data, filters]);

            // Pagination
            const totalItems = filteredData.length;
            const totalPages = Math.ceil(totalItems / pagination.size);
            const paginatedData = useMemo(() => {
                const start = (pagination.current - 1) * pagination.size;
                return filteredData.slice(start, start + pagination.size);
            }, [filteredData, pagination]);

            // Handlers
            const handleSearch = () => {
                setPagination(p => ({ ...p, current: 1 }));
            };

            const handleReset = () => {
                setFilters({ name: '', code: '', manager: '', dept: '', revenueType: 'plan', revenueMin: '', revenueMax: '' });
                setPagination(p => ({ ...p, current: 1 }));
            };

            // åˆ‡æ¢åˆ°å®é™…è¥æ”¶æ ‡ç­¾æ—¶è‡ªåŠ¨åŒæ­¥è®¡åˆ’æ•°æ®
            useEffect(() => {
                if (activeTab === 'actual' && planData.length > 0) {
                    setSaving(true);
                    setTimeout(() => {
                        setData(planData);
                        setSaving(false);
                    }, 300);
                }
            }, [activeTab]);

            // è¿›å…¥ç¼–è¾‘æ¨¡å¼
            const handleEdit = () => {
                if (!isFillingOpen) {
                    if (hasOpenedBefore) {
                        setModalContent('å½“å‰å¡«æŠ¥å·²æˆªæ­¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™');
                    } else {
                        setModalContent('å¡«æŠ¥å°šæœªå¼€å§‹ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™');
                    }
                    setModalOpen(true);
                    return;
                }
                setEditingData(JSON.parse(JSON.stringify(filteredData)));
                setIsEditing(true);
            };

            // ä¿å­˜ç¼–è¾‘
            const handleSave = () => {
                setSaving(true);
                setTimeout(() => {
                    // åœ¨å®é™…è¥æ”¶æ ‡ç­¾ä¿å­˜æ—¶ï¼Œè®°å½•ç”³è¯·äºº
                    const updatedData = editingData.map(item => {
                        if (activeTab === 'actual') {
                            return {
                                ...item,
                                applicant: 'å½“å‰ç”¨æˆ·' // è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„ç”¨æˆ·åï¼Œæš‚æ—¶ç”¨'å½“å‰ç”¨æˆ·'ä»£æ›¿
                            };
                        }
                        return item;
                    });
                    setData(updatedData);
                    // å¦‚æœåœ¨è®¡åˆ’è¥æ”¶æ ‡ç­¾ä¿å­˜ï¼ŒåŒæ­¥æ›´æ–°è®¡åˆ’æ•°æ®
                    if (activeTab === 'plan') {
                        setPlanData(updatedData);
                    }
                    setSaving(false);
                    setIsEditing(false);
                    setModalContent('ä¿å­˜æˆåŠŸï¼');
                    setModalOpen(true);
                }, 800);
            };

            // å–æ¶ˆç¼–è¾‘
            const handleCancelEdit = () => {
                setIsEditing(false);
                setEditingData([]);
            };

            // æ›´æ–°ç¼–è¾‘æ•°æ®
            const handleEditChange = (id, field, value) => {
                setEditingData(prev => prev.map(item =>
                    item.id === id ? { ...item, [field]: value } : item
                ));
            };

            // æ‹–æ‹½å¤„ç†å‡½æ•°
            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === dropIndex) return;

                const targetData = isEditing ? editingData : filteredData;
                const newData = [...targetData];
                const [draggedItem] = newData.splice(draggedIndex, 1);
                newData.splice(dropIndex, 0, draggedItem);

                if (isEditing) {
                    setEditingData(newData);
                } else {
                    // å¯¹äºæŸ¥çœ‹æ¨¡å¼ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŸå§‹æ•°æ®ä¸­æ›´æ–°é¡ºåº
                    const currentData = activeTab === 'plan' ? data : data;
                    const newOrderedData = [];
                    newData.forEach(item => {
                        const originalItem = currentData.find(d => d.id === item.id);
                        if (originalItem) newOrderedData.push(originalItem);
                    });
                    setData(newOrderedData);
                }

                setDraggedIndex(null);
            };

            const handleDragEnd = () => {
                setDraggedIndex(null);
            };

            // ä¸Šä¼ è¯æ˜ææ–™
            const handleUploadEvidence = (id) => {
                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.accept = '.pdf,.doc,.docx,.txt,.rtf,.jpg,.jpeg,.png';
                input.onchange = (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length === 0) return;

                    setEditingData(prev => prev.map(item => {
                        if (item.id === id) {
                            const currentFiles = Array.isArray(item.evidence) ? item.evidence : (item.evidence ? [item.evidence] : []);
                            const totalFiles = currentFiles.length + files.length;
                            if (totalFiles > 10) {
                                setModalContent(`æœ€å¤šåªèƒ½ä¸Šä¼ 10ä¸ªæ–‡ä»¶ï¼å½“å‰å·²æœ‰${currentFiles.length}ä¸ªï¼Œå°è¯•ä¸Šä¼ ${files.length}ä¸ª`);
                                setModalOpen(true);
                                return item;
                            }
                            const newFileNames = files.map(file => file.name);
                            return { ...item, evidence: [...currentFiles, ...newFileNames] };
                        }
                        return item;
                    }));
                };
                input.click();
            };

            // æŸ¥çœ‹è¯æ˜ææ–™
            const handleViewEvidence = (evidence) => {
                const modalContent = (
                    <div className="text-center">
                        <div className="text-4xl mb-4">ğŸ“„</div>
                        <p className="text-gray-700 mb-2">æ–‡ä»¶åï¼š{evidence}</p>
                        <p className="text-gray-500 text-sm">è¿™æ˜¯é¢„è§ˆåŠŸèƒ½çš„æ¨¡æ‹Ÿå±•ç¤º</p>
                        <p className="text-gray-400 text-xs mt-2">å®é™…ä½¿ç”¨æ—¶å¯ä»¥é›†æˆPDF.jsæˆ–å…¶ä»–é¢„è§ˆç»„ä»¶</p>
                    </div>
                );
                setModalContent(modalContent);
                setModalOpen(true);
            };

            // ä¸‹è½½è¯æ˜ææ–™
            const handleDownloadEvidence = (evidence) => {
                const link = document.createElement('a');
                link.href = '#';
                link.download = evidence;
                link.click();
                setModalContent(`æ–‡ä»¶ ${evidence} å·²å¼€å§‹ä¸‹è½½`);
                setModalOpen(true);
            };

            // åˆ é™¤è¯æ˜ææ–™
            const handleDeleteEvidence = (id, index) => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¯æ˜ææ–™å—ï¼Ÿ')) {
                    setEditingData(prev => prev.map(item => {
                        if (item.id === id && Array.isArray(item.evidence)) {
                            const newEvidence = item.evidence.filter((_, idx) => idx !== index);
                            return { ...item, evidence: newEvidence };
                        }
                        return item;
                    }));
                    setModalContent('è¯æ˜ææ–™å·²åˆ é™¤');
                    setModalOpen(true);
                }
            };

            // å®¡æ‰¹å¤„ç†
            const handleApproveItem = (id, actualRevenue, actualMargin, note) => {
                // æ›´æ–°æ•°æ®
                setEditingData(prev => prev.map(item =>
                    item.id === id 
                        ? { 
                            ...item, 
                            actualRevenue: actualRevenue || item.actualRevenue, 
                            actualMargin: actualMargin || item.actualMargin,
                            status: 'å·²ç¡®è®¤',
                            approval: note || 'åŒæ„',
                            confirmer: 'å½“å‰ç”¨æˆ·',
                            confirmTime: new Date().toLocaleString()
                        }
                        : item
                ));
                
                // å…³é—­å¼¹çª—
                setApprovalModalOpen(false);
                setSelectedApprovalItem(null);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                setModalContent('å®¡æ‰¹ç¡®è®¤æˆåŠŸï¼');
                setModalOpen(true);
            };

            const handleRejectItem = (id, note) => {
                // æ›´æ–°æ•°æ®
                setEditingData(prev => prev.map(item =>
                    item.id === id 
                        ? { 
                            ...item, 
                            status: 'å·²é€€å›',
                            approval: note || 'è¯·è¡¥å……ææ–™',
                            confirmer: 'å½“å‰ç”¨æˆ·',
                            confirmTime: new Date().toLocaleString()
                        }
                        : item
                ));
                
                // å…³é—­å¼¹çª—
                setApprovalModalOpen(false);
                setSelectedApprovalItem(null);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                setModalContent('å®¡æ‰¹é€€å›æˆåŠŸï¼');
                setModalOpen(true);
            };

            const handleOpenApproval = (item) => {
                if (!isFillingOpen && hasOpenedBefore) {
                    setModalContent('å½“å‰å¡«æŠ¥å·²æˆªæ­¢ï¼Œæ— æ³•è¿›è¡Œå®¡æ‰¹æ“ä½œ');
                    setModalOpen(true);
                    return;
                }
                setSelectedApprovalItem(item);
                setApprovalModalOpen(true);
            };

            const handleExport = () => {
                setSaving(true);
                setTimeout(() => {
                    setSaving(false);
                    setModalContent('å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½ã€‚');
                    setModalOpen(true);
                }, 800);
            };

            const handleDelete = (id) => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                    const newData = data.filter(item => item.id !== id);
                    setData(newData);
                    // åŒæ­¥åˆ é™¤è®¡åˆ’æ•°æ®ä¸­çš„è®°å½•
                    setPlanData(newData);
                    setModalContent('åˆ é™¤æˆåŠŸï¼');
                    setModalOpen(true);
                }
            };

            const handleBatchDelete = () => {
                if (selectedRows.length === 0) {
                    setModalContent('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•ï¼');
                    setModalOpen(true);
                    return;
                }
                if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRows.length} æ¡è®°å½•å—ï¼Ÿ`)) {
                    const newData = data.filter(item => !selectedRows.includes(item.id));
                    setData(newData);
                    // åŒæ­¥åˆ é™¤è®¡åˆ’æ•°æ®ä¸­çš„è®°å½•
                    setPlanData(newData);
                    setSelectedRows([]);
                    setModalContent('æ‰¹é‡åˆ é™¤æˆåŠŸï¼');
                    setModalOpen(true);
                }
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedRows(paginatedData.map(item => item.id));
                } else {
                    setSelectedRows([]);
                }
            };

            // Format number with thousand separator
            const formatNumber = (value) => {
                if (!value) return '';
                const num = Number(value);
                return isNaN(num) ? value : num.toLocaleString();
            };

            const handleSelectRow = (id) => {
                if (selectedRows.includes(id)) {
                    setSelectedRows(selectedRows.filter(rowId => rowId !== id));
                } else {
                    setSelectedRows([...selectedRows, id]);
                }
            };

            const handleAddProjects = (selectedProjects) => {
                if (selectedProjects.length === 0) {
                    setModalContent('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¡¹ç›®ï¼');
                    setModalOpen(true);
                    return;
                }

                let maxId = data.length > 0 ? Math.max(...data.map(d => d.id)) : 0;
                const newProjects = selectedProjects.map(project => {
                    maxId += 1;
                    return {
                        ...project,
                        id: maxId,
                        code: `PRJ-2025-${String(maxId).padStart(3, '0')}`,
                        planNewRevenue: '0',
                        contractAmount: project.contractAmount.toString(),
                        procurementProgress: '0%',
                        progressNote: '',
                        estRevenue: '',
                        actualRevenue: '0',
                        actualMargin: '0',
                        status: 'å¾…æäº¤',
                        approval: '',
                        confirmer: '',
                        confirmTime: '',
                        note: '',
                        evidence: '',
                        isNewlyAdded: true // æ ‡è®°ä¸ºæ–°æ·»åŠ çš„é¡¹ç›®
                    };
                });

                setData([...data, ...newProjects]);
                setAddModalOpen(false);
                setModalContent(`æˆåŠŸæ·»åŠ  ${selectedProjects.length} ä¸ªé¡¹ç›®ï¼`);
                setModalOpen(true);
            };

            const renderTableHeaders = () => (
                <tr className="text-xs font-semibold text-gray-700 bg-[#f5f7fa] border-b border-gray-200 whitespace-nowrap">
                    <th className="px-4 py-3 w-10 text-center fixed-left bg-[#f5f7fa]">
                        <input
                            type="checkbox"
                            checked={selectedRows.length > 0 && selectedRows.length === paginatedData.length}
                            onChange={handleSelectAll}
                            className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"
                        />
                    </th>
                    <th className="px-4 py-3 w-10 text-center fixed-left bg-[#f5f7fa]">åºå·</th>
                    <th className="px-4 py-3 min-w-[100px] text-left">å®æ–½éƒ¨é—¨</th>
                    <th className="px-4 py-3 min-w-[140px] text-left">é¡¹ç›®ç¼–å·</th>
                    <th className="px-4 py-3 min-w-[200px] text-left">é¡¹ç›®åç§°</th>

                    {/* Plan Specific Columns - moved after project name */}
                    {activeTab === 'plan' && (
                        <th className="px-4 py-3 min-w-[120px] text-right bg-blue-50/50 text-primary border-b-primary/20">è®¡åˆ’æ–°å¢è¥æ”¶(å…ƒ)</th>
                    )}

                    <th className="px-4 py-3 min-w-[100px] text-left">é¡¹ç›®é‡‡è´­è¿›åº¦</th>
                    <th className="px-4 py-3 min-w-[150px] text-left">é‡‡è´­è¿›åº¦è¯´æ˜</th>
                    <th className="px-4 py-3 min-w-[150px] text-left">å¤‡æ³¨</th>

                    <th className="px-4 py-3 min-w-[150px] text-left">ä¸šä¸»å•ä½</th>
                    <th className="px-4 py-3 min-w-[100px] text-left">é¡¹ç›®ç±»å‹</th>
                    <th className="px-4 py-3 min-w-[100px] text-left">ä¸šåŠ¡åˆ†ç±»</th>
                    <th className="px-4 py-3 min-w-[80px] text-left">é¡¹ç›®ç»ç†</th>
                    <th className="px-4 py-3 min-w-[120px] text-right">å«ç¨åˆåŒé‡‘é¢(å…ƒ)</th>
                    <th className="px-4 py-3 min-w-[80px] text-left">ç¨ç‡</th>
                    <th className="px-4 py-3 min-w-[100px] text-right">ç­–åˆ’æ¯›åˆ©ç‡(%)</th>

                    {/* These columns only show for actual tab */}
                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[120px] text-right bg-blue-50/50 text-primary border-b-primary/20">è®¡åˆ’æ–°å¢è¥æ”¶(å…ƒ)</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[140px] text-right bg-blue-50/50 text-primary border-b-primary/20">é¢„è®¡ç”³è¯·ç¡®è®¤è¥æ”¶(å…ƒ)</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[100px] text-center">è¯æ˜ææ–™</th>
                    )}

                    {activeTab === 'actual' && (
                        <>
                            <th className="px-4 py-3 min-w-[140px] text-right bg-green-50/50 text-success border-b-success/20">å®é™…ç¡®è®¤è¥æ”¶(å…ƒ)</th>
                            <th className="px-4 py-3 min-w-[140px] text-right bg-green-50/50 text-success border-b-success/20">å®é™…ç¡®è®¤æ¯›åˆ©(å…ƒ)</th>
                        </>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[100px] text-center">ç”³è¯·äºº</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[100px] text-center">çŠ¶æ€</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[150px]">å®¡æ‰¹æ„è§</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[80px]">ç¡®è®¤äºº</th>
                    )}

                    {activeTab === 'actual' && (
                        <th className="px-4 py-3 min-w-[140px]">ç¡®è®¤æ—¶é—´</th>
                    )}
                    <th className="px-4 py-3 min-w-[80px] text-center sticky right-0 bg-[#f5f7fa] shadow-sm">æ“ä½œ</th>
                </tr>
            );

            const inputStyle = "w-full text-xs px-2 py-1 border border-gray-300 rounded focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-colors";

            return (
                <div className="min-h-screen p-5 font-sans text-gray-800">
                    <div className="bg-white rounded shadow-sm min-h-[85vh] flex flex-col">
                        
                        {/* 1. Header & Tabs */}
                        <div className="flex items-center justify-between px-6 border-b border-gray-100">
                            <div className="flex pt-4">
                                <button
                                    onClick={() => setActiveTab('plan')}
                                    className={`mr-8 pb-3 text-sm font-medium transition-colors border-b-2 ${
                                        activeTab === 'plan'
                                            ? 'border-primary text-primary'
                                            : 'border-transparent text-gray-600 hover:text-primary'
                                    }`}
                                >
                                    è®¡åˆ’è¥æ”¶
                                </button>
                                <button
                                    onClick={() => setActiveTab('actual')}
                                    className={`mr-8 pb-3 text-sm font-medium transition-colors border-b-2 ${
                                        activeTab === 'actual'
                                            ? 'border-primary text-primary'
                                            : 'border-transparent text-gray-600 hover:text-primary'
                                    }`}
                                >
                                    å®é™…è¥æ”¶
                                </button>
                            </div>
                            <div className="flex items-center gap-2 pt-4">
                                <span className="text-sm text-gray-600">å¡«æŠ¥æœˆä»½ï¼š</span>
                                <select
                                    value={selectedYear}
                                    onChange={(e) => setSelectedYear(Number(e.target.value))}
                                    className="h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary bg-white"
                                >
                                    {Array.from({ length: 5 }, (_, i) => currentYear - 2 + i).map(year => (
                                        <option key={year} value={year}>{year}å¹´</option>
                                    ))}
                                </select>
                                <select
                                    value={selectedMonth}
                                    onChange={(e) => setSelectedMonth(Number(e.target.value))}
                                    className="h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary bg-white"
                                >
                                    {Array.from({ length: 12 }, (_, i) => i + 1).map(month => (
                                        <option key={month} value={month}>{month}æœˆ</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        {/* 2. Deadline Display */}
                        <div className="px-5 py-3 border-b border-gray-100 bg-orange-50/50">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 text-sm">
                                    <span className="text-gray-600">{selectedYear}å¹´{selectedMonth}æœˆå¡«æŠ¥æˆªæ­¢æ—¶é—´ï¼š</span>
                                    <span
                                        className={`font-semibold ${isFillingOpen ? 'cursor-pointer hover:underline text-green-600' : 'text-gray-600'}`}
                                        onClick={() => isFillingOpen && setDeadlineModalOpen(true)}
                                        title={isFillingOpen ? 'ç‚¹å‡»ä¿®æ”¹æˆªæ­¢æ—¶é—´' : hasOpenedBefore ? 'å¡«æŠ¥å·²å…³é—­' : 'å¡«æŠ¥å°šæœªå¼€å§‹'}
                                    >
                                        {deadline.toLocaleDateString('zh-CN')}
                                    </span>
                                </div>
                                <div className="flex items-center gap-4 text-sm">
                                    {isFillingOpen ? (
                                        <div className="flex items-center gap-2">
                                            <span className="text-gray-600">å€’è®¡æ—¶ï¼š</span>
                                            <div className="flex items-center gap-2">
                                                <span className="inline-flex items-center justify-center w-10 h-8 bg-green-100 text-green-600 rounded font-semibold">
                                                    {String(countdown.days).padStart(2, '0')}
                                                </span>
                                                <span className="text-gray-500">å¤©</span>
                                                <span className="inline-flex items-center justify-center w-10 h-8 bg-green-100 text-green-600 rounded font-semibold">
                                                    {String(countdown.hours).padStart(2, '0')}
                                                </span>
                                                <span className="text-gray-500">æ—¶</span>
                                                <span className="inline-flex items-center justify-center w-10 h-8 bg-green-100 text-green-600 rounded font-semibold">
                                                    {String(countdown.minutes).padStart(2, '0')}
                                                </span>
                                                <span className="text-gray-500">åˆ†</span>
                                                <span className="inline-flex items-center justify-center w-10 h-8 bg-green-100 text-green-600 rounded font-semibold">
                                                    {String(countdown.seconds).padStart(2, '0')}
                                                </span>
                                                <span className="text-gray-500">ç§’</span>
                                            </div>
                                        </div>
                                    ) : hasOpenedBefore ? (
                                        <span className="text-red-600 font-semibold">å¡«æŠ¥å·²å…³é—­</span>
                                    ) : (
                                        <span className="text-orange-600 font-semibold">å¡«æŠ¥å°šæœªå¼€å§‹</span>
                                    )}
                                    <button
                                        onClick={isFillingOpen ? handleCloseFilling : handleOpenFilling}
                                        className={`px-4 py-1.5 text-sm rounded transition-colors ${
                                            isFillingOpen
                                                ? 'bg-red-500 text-white hover:bg-red-600'
                                                : 'bg-success text-white hover:bg-green-600'
                                        }`}
                                    >
                                        {isFillingOpen ? 'å…³é—­å¡«æŠ¥' : 'å¼€å¯å¡«æŠ¥'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 3. Filter Bar */}
                        <div className="p-5 border-b border-gray-100 bg-gray-50/30">
                            <div className="flex flex-wrap items-center gap-4">
                                <div className="flex items-center">
                                    <label className="text-sm text-gray-600 mr-2">é¡¹ç›®åç§°</label>
                                    <input 
                                        type="text" 
                                        placeholder="æ¨¡ç³Šæœç´¢" 
                                        className="w-40 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                        value={filters.name}
                                        onChange={e => setFilters({...filters, name: e.target.value})}
                                    />
                                </div>
                                <div className="flex items-center">
                                    <label className="text-sm text-gray-600 mr-2">é¡¹ç›®ç¼–å·</label>
                                    <input 
                                        type="text" 
                                        placeholder="è¯·è¾“å…¥" 
                                        className="w-32 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                        value={filters.code}
                                        onChange={e => setFilters({...filters, code: e.target.value})}
                                    />
                                </div>
                                <div className="flex items-center">
                                    <label className="text-sm text-gray-600 mr-2">é¡¹ç›®ç»ç†</label>
                                    <input
                                        type="text"
                                        placeholder="è¯·è¾“å…¥"
                                        className="w-32 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                        value={filters.manager}
                                        onChange={e => setFilters({...filters, manager: e.target.value})}
                                    />
                                </div>
                                <div className="flex items-center">
                                    <label className="text-sm text-gray-600 mr-2">å®æ–½éƒ¨é—¨</label>
                                    <input
                                        type="text"
                                        placeholder="è¯·è¾“å…¥"
                                        className="w-32 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                        value={filters.dept}
                                        onChange={e => setFilters({...filters, dept: e.target.value})}
                                    />
                                </div>
                                <div className="flex items-center">
                                    <label className="text-sm text-gray-600 mr-2">è¥æ”¶é‡‘é¢</label>
                                    <select
                                        className="w-28 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary bg-white"
                                        value={filters.revenueType}
                                        onChange={e => setFilters({...filters, revenueType: e.target.value})}
                                    >
                                        <option value="plan">è®¡åˆ’è¥æ”¶</option>
                                        <option value="actual">å®é™…è¥æ”¶</option>
                                        <option value="confirmed">ç¡®è®¤è¥æ”¶</option>
                                    </select>
                                    <input
                                        type="number"
                                        placeholder="æœ€å°å€¼"
                                        className="w-24 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400 ml-2"
                                        value={filters.revenueMin}
                                        onChange={e => setFilters({...filters, revenueMin: e.target.value})}
                                    />
                                    <span className="text-gray-400 mx-1">-</span>
                                    <input
                                        type="number"
                                        placeholder="æœ€å¤§å€¼"
                                        className="w-24 h-8 px-2 text-sm border border-gray-300 rounded outline-none focus:border-primary placeholder-gray-400"
                                        value={filters.revenueMax}
                                        onChange={e => setFilters({...filters, revenueMax: e.target.value})}
                                    />
                                </div>
                                <div className="flex items-center gap-2 ml-auto">
                                    <button onClick={handleSearch} className="px-4 py-1.5 bg-primary text-white text-sm rounded hover:bg-primary-hover transition-colors shadow-sm flex items-center">
                                        <Search size={14} className="mr-1"/> æŸ¥è¯¢
                                    </button>
                                    <button onClick={handleReset} className="px-4 py-1.5 bg-white border border-gray-300 text-gray-600 text-sm rounded hover:border-primary hover:text-primary transition-colors flex items-center">
                                        <RefreshCw size={14} className="mr-1"/> é‡ç½®
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* 4. Action Bar */}
                        <div className="px-5 py-3 flex gap-3 border-b border-gray-100">
                            {!isEditing ? (
                                <>
                                    <button
                                        onClick={handleEdit}
                                        disabled={saving || !isFillingOpen}
                                        className="flex items-center px-4 py-1.5 bg-primary text-white text-sm rounded hover:bg-primary-hover shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        title={!isFillingOpen ? (hasOpenedBefore ? 'å½“å‰å¡«æŠ¥å·²æˆªæ­¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™' : 'å¡«æŠ¥å°šæœªå¼€å§‹ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™') : ''}
                                    >
                                        ç¼–è¾‘
                                    </button>
                                    <button
                                        onClick={() => setAddModalOpen(true)}
                                        disabled={!isFillingOpen}
                                        className="flex items-center px-4 py-1.5 bg-white border border-gray-300 text-gray-600 text-sm rounded hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        title={!isFillingOpen ? (hasOpenedBefore ? 'å½“å‰å¡«æŠ¥å·²æˆªæ­¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™' : 'å¡«æŠ¥å°šæœªå¼€å§‹ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™') : ''}
                                    >
                                        <Plus size={14} className="mr-1"/> æ–°å¢é¡¹ç›®
                                    </button>
                                    <button
                                        onClick={handleBatchDelete}
                                        disabled={selectedRows.length === 0 || saving || !isFillingOpen}
                                        className="flex items-center px-4 py-1.5 bg-white border border-gray-300 text-red-500 text-sm rounded hover:border-red-500 hover:text-red-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        title={!isFillingOpen ? (hasOpenedBefore ? 'å½“å‰å¡«æŠ¥å·²æˆªæ­¢ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™' : 'å¡«æŠ¥å°šæœªå¼€å§‹ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€å¯åå†å¡«å†™') : ''}
                                    >
                                        åˆ é™¤ ({selectedRows.length})
                                    </button>
                                    <button onClick={handleExport} disabled={saving} className="flex items-center px-4 py-1.5 bg-white border border-gray-300 text-gray-600 text-sm rounded hover:border-primary hover:text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        <Download size={14} className="mr-1"/> å¯¼å‡ºåˆ—è¡¨
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button onClick={handleSave} disabled={saving} className="flex items-center px-4 py-1.5 bg-success text-white text-sm rounded hover:bg-green-600 shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                        {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                                    </button>
                                    <button onClick={handleCancelEdit} className="flex items-center px-4 py-1.5 bg-white border border-gray-300 text-gray-600 text-sm rounded hover:border-gray-400 transition-colors">
                                        å–æ¶ˆ
                                    </button>
                                </>
                            )}
                            <div className="ml-auto flex items-center text-sm text-gray-500">
                                <span className="mr-4">æ€»è®¡åˆ’è¥æ”¶: <span className="text-primary font-semibold">Â¥{data.reduce((sum, item) => sum + Number(item.planNewRevenue), 0).toLocaleString()}</span></span>
                                {activeTab === 'actual' && (
                                    <span>æ€»å®é™…è¥æ”¶: <span className="text-success font-semibold">Â¥{data.reduce((sum, item) => sum + Number(item.actualRevenue), 0).toLocaleString()}</span></span>
                                )}
                            </div>
                        </div>

                        {/* 4. Table */}
                        <div className="flex-1 overflow-x-auto custom-scroll relative">
                            <table className="w-full text-sm text-left border-collapse">
                                <thead>
                                    {renderTableHeaders()}
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {loading ? (
                                        <tr><td colSpan={activeTab === 'plan' ? 14 : 22} className="text-center py-20 text-gray-400">
                                            <div className="flex flex-col items-center gap-3">
                                                <div className="spinner"></div>
                                                <span>åŠ è½½ä¸­...</span>
                                            </div>
                                        </td></tr>
                                    ) : paginatedData.length === 0 ? (
                                        <tr><td colSpan={activeTab === 'plan' ? 14 : 22} className="text-center py-20 text-gray-400">
                                            <div className="flex flex-col items-center gap-3">
                                                <div className="text-4xl opacity-30">ğŸ“‹</div>
                                                <span>æš‚æ— æ•°æ®</span>
                                            </div>
                                        </td></tr>
                                    ) : (
                                        paginatedData.map((item, index) => {
                                            // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨editingDataä¸­å¯¹åº”çš„é¡¹ç›®
                                            const displayItem = isEditing ? editingData.find(d => d.id === item.id) || item : item;
                                            return (
                                            <tr
                                                key={item.id}
                                                className="hover:bg-gray-50 transition-colors cursor-move"
                                                draggable
                                                onDragStart={(e) => handleDragStart(e, index)}
                                                onDragOver={handleDragOver}
                                                onDrop={(e) => handleDrop(e, index)}
                                                onDragEnd={handleDragEnd}
                                                style={{
                                                    opacity: draggedIndex === index ? 0.5 : 1,
                                                    backgroundColor: draggedIndex !== null && draggedIndex !== index ? '#f0fdf4' : 'inherit'
                                                }}
                                            >
                                                <td className="px-4 py-3 text-center text-gray-500 bg-white sticky-left">
                                                    <input
                                                        type="checkbox"
                                                        checked={selectedRows.includes(item.id)}
                                                        onChange={() => handleSelectRow(item.id)}
                                                        className="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary"
                                                    />
                                                </td>
                                                <td className="px-4 py-3 text-center text-gray-500 bg-white sticky-left">{(pagination.current - 1) * pagination.size + index + 1}</td>
                                                <td className="px-4 py-3 text-left text-gray-600">{item.dept}</td>
                                                <td className="px-4 py-3 text-left text-gray-600 font-mono text-xs">{item.code}</td>
                                                <td className="px-4 py-3 text-left text-gray-700">{item.name}</td>

                                                {/* Plan Specific Columns - moved after project name */}
                                                {activeTab === 'plan' && (
                                                    <td className="px-4 py-3 bg-blue-50/20">
                                                        {isEditing ? (
                                                            <input
                                                                type="text"
                                                                value={formatNumber(displayItem.planNewRevenue)}
                                                                onChange={(e) => handleEditChange(item.id, 'planNewRevenue', e.target.value)}
                                                                className={`${inputStyle} text-right border-blue-200 focus:border-primary`}
                                                                placeholder="è¯·è¾“å…¥é‡‘é¢"
                                                            />
                                                        ) : (
                                                            <span className="text-right block text-gray-700 font-mono">{formatNumber(displayItem.planNewRevenue)}</span>
                                                        )}
                                                    </td>
                                                )}

                                                <td className="px-4 py-3">
                                                    {activeTab === 'plan' && isEditing ? (
                                                        <input
                                                            type="text"
                                                            value={displayItem.procurementProgress}
                                                            onChange={(e) => handleEditChange(item.id, 'procurementProgress', e.target.value)}
                                                            className={inputStyle}
                                                        />
                                                    ) : (
                                                        <span className="text-gray-700">{displayItem.procurementProgress}</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {activeTab === 'plan' && isEditing ? (
                                                        <input
                                                            type="text"
                                                            value={displayItem.progressNote}
                                                            onChange={(e) => handleEditChange(item.id, 'progressNote', e.target.value)}
                                                            className={inputStyle}
                                                        />
                                                    ) : (
                                                        <span className="text-gray-700">{displayItem.progressNote}</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3">
                                                    {activeTab === 'plan' && isEditing ? (
                                                        <input
                                                            type="text"
                                                            value={displayItem.note}
                                                            onChange={(e) => handleEditChange(item.id, 'note', e.target.value)}
                                                            className={inputStyle}
                                                        />
                                                    ) : (
                                                        <span className="text-gray-700">{displayItem.note}</span>
                                                    )}
                                                </td>

                                                <td className="px-4 py-3 text-left text-gray-600">{displayItem.owner}</td>
                                                <td className="px-4 py-3 text-left text-gray-600">{displayItem.type}</td>
                                                <td className="px-4 py-3 text-left text-gray-700">{displayItem.category}</td>
                                                <td className="px-4 py-3 text-left text-gray-600">{displayItem.manager}</td>
                                                <td className="px-4 py-3 text-right font-mono" title={displayItem.contractAmount}>{Number(displayItem.contractAmount).toLocaleString()}</td>
                                                <td className="px-4 py-3 text-left">{displayItem.taxRate}</td>
                                                <td className="px-4 py-3 text-right">{displayItem.margin}</td>

                                                {/* These columns only show for actual tab */}
                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 bg-blue-50/20 text-right font-mono">
                                                        {isEditing && item.isNewlyAdded ? (
                                                            <input
                                                                type="text"
                                                                value={formatNumber(item.planNewRevenue)}
                                                                onChange={(e) => handleEditChange(item.id, 'planNewRevenue', e.target.value)}
                                                                className={`${inputStyle} text-right border-blue-200 focus:border-primary`}
                                                                placeholder="è¯·è¾“å…¥é‡‘é¢"
                                                            />
                                                        ) : (
                                                            <span className="text-gray-700 font-mono">{formatNumber(item.planNewRevenue)}</span>
                                                        )}
                                                    </td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 bg-blue-50/20">
                                                        {isEditing ? (
                                                            <input
                                                                type="text"
                                                                value={formatNumber(item.estRevenue)}
                                                                onChange={(e) => handleEditChange(item.id, 'estRevenue', e.target.value)}
                                                                className={`${inputStyle} text-right border-blue-200 focus:border-primary`}
                                                                placeholder="è¯·è¾“å…¥é‡‘é¢"
                                                            />
                                                        ) : (
                                                            <span className="text-right block text-gray-700 font-mono">{formatNumber(item.estRevenue)}</span>
                                                        )}
                                                    </td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-center">
                                                        {item.evidence && item.evidence.length > 0 ? (
                                                            <div className="flex flex-col items-start gap-1 max-w-[200px] mx-auto">
                                                                {item.evidence.map((ev, idx) => {
                                                                    const canPreview = /\.(pdf|doc|docx|txt|rtf)$/i.test(ev);
                                                                    return (
                                                                        <div key={idx} className="flex items-center gap-2 w-full">
                                                                            <span
                                                                                className={`text-xs truncate flex-1 cursor-pointer ${canPreview ? 'text-primary hover:underline font-medium' : 'text-gray-600'}`}
                                                                                title={ev}
                                                                                onClick={() => canPreview && handleViewEvidence(ev)}
                                                                            >
                                                                                {ev}
                                                                            </span>
                                                                            <button
                                                                                onClick={() => handleDownloadEvidence(ev)}
                                                                                className="text-gray-400 hover:text-primary text-xs"
                                                                                title="ä¸‹è½½"
                                                                            >
                                                                                <Download size={12} />
                                                                            </button>
                                                                            {isEditing && item.status !== 'å·²ç¡®è®¤' && (
                                                                                <button
                                                                                    onClick={() => handleDeleteEvidence(item.id, idx)}
                                                                                    className="text-gray-400 hover:text-red-500 text-xs"
                                                                                    title="åˆ é™¤"
                                                                                >
                                                                                    âœ•
                                                                                </button>
                                                                            )}
                                                                        </div>
                                                                    );
                                                                })}
                                                                {isEditing && item.status !== 'å·²ç¡®è®¤' && item.evidence.length < 10 && (
                                                                    <button
                                                                        onClick={() => handleUploadEvidence(item.id)}
                                                                        className="text-xs text-primary hover:text-primary-hover cursor-pointer mt-1"
                                                                    >
                                                                        + ç»§ç»­ä¸Šä¼  ({item.evidence.length}/10)
                                                                    </button>
                                                                )}
                                                            </div>
                                                        ) : (
                                                            isEditing && item.status !== 'å·²ç¡®è®¤' ? (
                                                                <button
                                                                    onClick={() => handleUploadEvidence(item.id)}
                                                                    className="text-gray-400 text-xs flex items-center justify-center cursor-pointer hover:text-primary"
                                                                >
                                                                    <Upload size={12} className="mr-1"/> ä¸Šä¼ ææ–™
                                                                </button>
                                                            ) : (
                                                                <span className="text-gray-300 text-xs">
                                                                    -
                                                                </span>
                                                            )
                                                        )}
                                                    </td>
                                                )}

                                                {/* Actual Specific */}
                                                {activeTab === 'actual' && (
                                                    <>
                                                        <td className="px-4 py-3 bg-green-50/20">
                                                            {isEditing && item.status !== 'å·²ç¡®è®¤' ? (
                                                                <input
                                                                    type="text"
                                                                    value={formatNumber(item.actualRevenue)}
                                                                    onChange={(e) => handleEditChange(item.id, 'actualRevenue', e.target.value)}
                                                                    className={`${inputStyle} text-right border-green-200 focus:border-success`}
                                                                    placeholder="è¯·è¾“å…¥é‡‘é¢"
                                                                />
                                                            ) : (
                                                                <span className="text-right block text-gray-700 font-mono">{formatNumber(item.actualRevenue)}</span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3 bg-green-50/20">
                                                            {isEditing && item.status !== 'å·²ç¡®è®¤' ? (
                                                                <input
                                                                    type="text"
                                                                    value={formatNumber(item.actualMargin)}
                                                                    onChange={(e) => handleEditChange(item.id, 'actualMargin', e.target.value)}
                                                                    className={`${inputStyle} text-right border-green-200 focus:border-success`}
                                                                    placeholder="è¯·è¾“å…¥é‡‘é¢"
                                                                />
                                                            ) : (
                                                                <span className="text-right block text-gray-700 font-mono">{formatNumber(item.actualMargin)}</span>
                                                            )}
                                                        </td>
                                                    </>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-center text-gray-600">{item.applicant || '-'}</td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-center">
                                                        <StatusTag status={item.status} />
                                                    </td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-gray-500 text-xs truncate max-w-[150px]" title={item.approval}>{item.approval}</td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-gray-600">{item.confirmer}</td>
                                                )}

                                                {activeTab === 'actual' && (
                                                    <td className="px-4 py-3 text-gray-500 text-xs">{item.confirmTime}</td>
                                                )}

                                                {/* Actions */}
                                                <td className="px-4 py-3 text-center sticky right-0 bg-white shadow-sm border-l border-gray-100">
                                                    {!isEditing && (
                                                        <>
                                                            <button
                                                                onClick={() => handleDelete(item.id)}
                                                                className="text-red-500 hover:text-red-600 text-xs font-medium"
                                                            >
                                                                åˆ é™¤
                                                            </button>
                                                            {isFillingOpen && (
                                                                <button
                                                                    onClick={() => handleOpenApproval(item)}
                                                                    className="text-primary hover:text-primary-dark text-xs font-medium ml-2"
                                                                    title="å¤„ç†å®¡æ‰¹"
                                                                >
                                                                    å¤„ç†
                                                                </button>
                                                            )}
                                                        </>
                                                    )}
                                                </td>
                                            </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>

                        {/* 5. Pagination */}
                         <div className="flex items-center justify-between px-5 py-4 border-t border-gray-100 bg-white">
                            <div className="text-sm text-gray-500">
                                å…± <span className="text-gray-800 font-medium">{totalItems}</span> æ¡
                                {activeTab === 'plan' && (
                                    <span className="ml-4 text-success">è®¡åˆ’è¥æ”¶åˆè®¡: Â¥{paginatedData.reduce((sum, item) => sum + Number(item.planNewRevenue), 0).toLocaleString()}</span>
                                )}
                                {activeTab === 'actual' && (
                                    <span className="ml-4 text-success">å®é™…è¥æ”¶åˆè®¡: Â¥{paginatedData.reduce((sum, item) => sum + Number(item.actualRevenue), 0).toLocaleString()}</span>
                                )}
                            </div>
                            <div className="flex items-center space-x-2 text-sm">
                                <button 
                                    disabled={pagination.current === 1}
                                    onClick={() => setPagination(p => ({...p, current: p.current - 1}))}
                                    className="p-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed bg-white"
                                >
                                    <ChevronLeft size={16} className="text-gray-500" />
                                </button>
                                
                                {Array.from({length: Math.min(5, totalPages)}, (_, i) => i + 1).map(p => (
                                    <button
                                        key={p}
                                        onClick={() => setPagination(prev => ({...prev, current: p}))}
                                        className={`w-7 h-7 flex items-center justify-center border rounded text-xs transition-colors ${
                                            pagination.current === p 
                                                ? 'bg-primary text-white border-primary' 
                                                : 'bg-white hover:bg-gray-50 text-gray-600 border-gray-200'
                                        }`}
                                    >
                                        {p}
                                    </button>
                                ))}
                                
                                <button 
                                    disabled={pagination.current === totalPages}
                                        onClick={() => setPagination(p => ({...p, current: p.current + 1}))}
                                    className="p-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed bg-white"
                                >
                                    <ChevronRight size={16} className="text-gray-500" />
                                </button>
                                
                                <select 
                                    value={pagination.size}
                                    onChange={(e) => setPagination({current: 1, size: Number(e.target.value)})}
                                    className="border border-gray-200 rounded px-2 py-1 ml-2 outline-none focus:border-primary text-gray-600 h-7 text-xs bg-white"
                                >
                                    <option value={10}>10æ¡/é¡µ</option>
                                    <option value={20}>20æ¡/é¡µ</option>
                                    <option value={50}>50æ¡/é¡µ</option>
                                </select>
                            </div>
                        </div>

                    </div>

                    {/* Modals */}
                    <Modal
                        isOpen={modalOpen}
                        onClose={() => setModalOpen(false)}
                        title="æç¤º"
                    >
                        {modalContent}
                    </Modal>

                    <ApprovalModal
                        isOpen={approvalModalOpen}
                        onClose={() => {
                            setApprovalModalOpen(false);
                            setSelectedApprovalItem(null);
                        }}
                        item={selectedApprovalItem}
                        onApprove={handleApproveItem}
                        onReject={handleRejectItem}
                    />

                    <DeadlineModal
                        isOpen={deadlineModalOpen}
                        onClose={() => setDeadlineModalOpen(false)}
                        onConfirm={(date) => {
                            setNewDeadline(date);
                            handleConfirmDeadline();
                        }}
                    />

                    <AddProjectModal
                        isOpen={addModalOpen}
                        onClose={() => setAddModalOpen(false)}
                        onAdd={handleAddProjects}
                        existingData={data}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);;
    </script>
</body>
</html>