<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”®ç”µåˆåŒç®¡ç†ç³»ç»Ÿ (å¹¿è¥¿å›½ä¼ç‰ˆ)</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            font-size: 13px;
        }
        .main-container { padding: 20px; }

        /* --- é¡µç­¾ä¸æœç´¢ --- */
        .tabs-nav {
            display: flex; background: #fff; margin-bottom: 2px; border-radius: 4px 4px 0 0; padding: 0 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .tab-item {
            padding: 16px 20px; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; transition: all 0.3s;
        }
        .tab-item:hover { color: #1890ff; }
        .tab-item.active { color: #1890ff; border-bottom-color: #1890ff; }

        .search-panel { background: #fff; padding: 20px; border-radius: 0 0 2px 2px; margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
        .search-item { display: flex; align-items: center; }
        .search-label { margin-right: 10px; font-weight: 500; white-space: nowrap; }

        /* --- æŒ‰é’® --- */
        .btn {
            border: 1px solid transparent; cursor: pointer; padding: 4px 15px; font-size: 13px; border-radius: 2px; height: 32px; transition: all 0.3s;
        }
        .btn-primary { background: #1890ff; color: #fff; border-color: #1890ff; }
        .btn-primary:hover { background: #40a9ff; border-color: #40a9ff; }
        .btn-default { background: #fff; border-color: #d9d9d9; color: #333; }
        .btn-default:hover { color: #40a9ff; border-color: #40a9ff; }
        
        .btn-link { background: none; border: none; padding: 0 5px; color: #1890ff; box-shadow: none; height: auto; cursor: pointer; }
        .btn-link:hover { text-decoration: underline; }
        .btn-link.danger { color: #ff4d4f; }
        
        .action-panel { margin-bottom: 16px; display: flex; gap: 10px; }

        /* --- è¡¨æ ¼æ ·å¼ --- */
        .table-wrapper { background: #fff; border-radius: 2px; overflow-x: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1500px; }
        th, td { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; white-space: nowrap; }
        th { background: #fafafa; font-weight: 600; color: #000000d9; }
        .align-right { text-align: right; }
        .align-center { text-align: center; }
        .sticky-col { position: sticky; right: 0; background: #fff; z-index: 2; box-shadow: -2px 0 6px rgba(0,0,0,0.05); text-align: center; }
        th.sticky-col { background: #fafafa; }

        /* é“¾æ¥ä¸æ ‡ç­¾ */
        .customer-link, .contract-link, .assoc-link { color: #1890ff; cursor: pointer; text-decoration: none; margin-right: 4px; }
        .customer-link:hover, .contract-link:hover, .assoc-link:hover { text-decoration: underline; }
        
        .level-tag {
            display: inline-block; font-size: 11px; color: #1890ff; background-color: #e6f7ff;
            border: 1px solid #91d5ff; padding: 0 4px; border-radius: 2px; line-height: 16px;
            vertical-align: middle; transform: translateY(-1px);
        }
        
        .count-link { color: #1890ff; font-weight: bold; cursor: pointer; border-bottom: 1px dashed #1890ff; }
        
        /* Tooltip */
        #global-tooltip {
            position: fixed; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 8px 12px;
            border-radius: 4px; font-size: 12px; z-index: 9999; pointer-events: none; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); line-height: 1.5; white-space: pre-wrap;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .status-tag { padding: 2px 8px; border-radius: 2px; font-size: 12px; border: 1px solid; }
        .st-active { color: #52c41a; background: #f6ffed; border-color: #b7eb8f; }
        .st-draft { color: #faad14; background: #fffbe6; border-color: #ffe58f; }
        .st-end { color: #ff4d4f; background: #fff2f0; border-color: #ffccc7; }
        .st-expired { color: #8c8c8c; background: #f5f5f5; border-color: #d9d9d9; }

        /* --- è¡¨å•æ§ä»¶ --- */
        .ant-input, .ant-select {
            width: 100%; height: 32px; padding: 4px 11px; border: 1px solid #d9d9d9; border-radius: 2px; outline: none; transition: all 0.3s;
        }
        .ant-input:focus, .ant-select:focus { border-color: #40a9ff; box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }
        .ant-input:disabled, .ant-select:disabled { background: #f5f5f5; cursor: not-allowed; color: #00000040; }
        
        textarea.ant-input { height: auto; min-height: 100px; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-mask {
            position: fixed; top: 0; right: 0; bottom: 0; left: 0; z-index: 1000;
            background-color: rgba(0,0,0,0.45); display: none; justify-content: center; align-items: center;
        }
        .modal-mask.show { display: flex; }
        .modal-wrapper { width: 900px; background: #fff; border-radius: 4px; display: flex; flex-direction: column; max-height: 90vh; }
        
        /* è°ƒæ•´ 2ï¼šå˜æ›´è®°å½•å¼¹çª—åŠ å®½ */
        .modal-wrapper.wide { width: 90vw; max-width: 1200px; }
        
        .modal-header { padding: 16px 24px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; font-size: 16px; font-weight: 500; }
        .modal-body { padding: 24px 30px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 12px 24px; border-top: 1px solid #f0f0f0; text-align: right; }

        /* è¡¨å•å¸ƒå±€ */
        .form-section { display: none; }
        .form-section.active { display: block; }
        .form-row { display: flex; margin-bottom: 20px; align-items: flex-start; }
        
        .form-label { width: 100px; text-align: right; margin-right: 12px; padding-top: 5px; color: #333; flex-shrink: 0; }
        .form-label.required::before { content: '*'; color: #ff4d4f; margin-right: 4px; }
        
        .form-input-box { flex: 1; position: relative; }
        .input-suffix-group { display: flex; align-items: center; width: 100%; position: relative; }
        .suffix-text { margin-left: 8px; color: #999; white-space: nowrap; }
        .cascader-group { display: flex; gap: 10px; }
        .cascader-group .ant-select { flex: 1; }

        /* åˆ†æ å¸ƒå±€ */
        .split-row { display: flex; flex: 1; gap: 20px; }
        .split-item { flex: 1; display: flex; }
        .split-item .form-input-box { flex: 1; }

        /* é™„ä»¶ä¸Šä¼ æ ·å¼ */
        .upload-box { border: 1px dashed #d9d9d9; border-radius: 2px; padding: 10px; background: #fafafa; transition: border-color 0.3s; }
        .upload-box:hover { border-color: #40a9ff; }
        .file-list { margin-top: 8px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; background: #fff; margin-bottom: 4px; border-radius: 2px; border: 1px solid #f0f0f0; font-size: 12px; }
        .file-item:hover { background: #e6f7ff; }
        .file-remove { color: #ff4d4f; cursor: pointer; margin-left: 8px; }

        /* --- å˜æ›´è®°å½•å¯¹æ¯”æ ·å¼ --- */
        .history-layout { display: flex; height: 500px; border: 1px solid #f0f0f0; }
        .history-list { width: 300px; border-right: 1px solid #f0f0f0; overflow-y: auto; background: #fafafa; flex-shrink: 0; }
        .history-item { padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; }
        .history-item:hover { background: #e6f7ff; }
        .history-item.active { background: #bae7ff; border-left: 4px solid #1890ff; }
        .history-item .meta { font-size: 12px; color: #999; margin-bottom: 4px; }
        .history-item .desc { font-size: 13px; color: #333; font-weight: 500; }
        
        .history-detail { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .diff-table { width: 100%; border-collapse: collapse; }
        .diff-table th, .diff-table td { border: 1px solid #e8e8e8; padding: 10px; text-align: left; }
        .diff-table th { background: #fafafa; font-weight: 600; width: 25%; }
        .diff-old { color: #ff4d4f; text-decoration: line-through; background: #fff1f0; }
        .diff-new { color: #52c41a; background: #f6ffed; }

        /* --- æ—¥æœŸç»„ä»¶æ ·å¼ (ç®€ç‰ˆ) --- */
        .month-range-editor { position: relative; width: 100%; }
        .range-input-wrapper { display: flex; align-items: center; width: 100%; height: 32px; border: 1px solid #d9d9d9; border-radius: 2px; padding: 0 11px; cursor: pointer; background: #fff; }
        .picker-panel { position: absolute; top: 100%; left: 0; margin-top: 5px; z-index: 2000; background: #fff; border: 1px solid #e4e7ed; box-shadow: 0 2px 12px rgba(0,0,0,0.1); display: none; width: 600px; }
        .picker-panel.show { display: flex; }
        .picker-content { width: 50%; padding: 10px; border-right: 1px solid #eee; }
        .month-table { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .month-cell { text-align: center; cursor: pointer; padding: 8px 0; font-size: 12px; }
        .month-cell:hover { color: #1890ff; }

        /* --- ç»„ç»‡æ ‘å½¢é€‰æ‹©æ ·å¼ (æ–°å¢åŠå®Œå–„) --- */
        .tree-select-wrapper { position: relative; width: 100%; }
        .tree-select-input {
            width: 100%; height: 32px; padding: 4px 11px; border: 1px solid #d9d9d9; border-radius: 2px; 
            cursor: pointer; background: #fff; display: flex; align-items: center; overflow: hidden;
        }
        .tree-select-input:hover { border-color: #40a9ff; }
        .tree-select-input.disabled { background: #f5f5f5; cursor: not-allowed; }
        .tree-dropdown {
            position: absolute; top: 100%; left: 0; width: 100%; max-height: 300px; overflow-y: auto;
            background: #fff; border: 1px solid #d9d9d9; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none; margin-top: 4px; border-radius: 2px;
        }
        .tree-dropdown.show { display: block; }

        /* æ ‘èŠ‚ç‚¹æ•´ä½“æ ·å¼ */
        .tree-node-item { display: block; }
        .tree-node-header {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
            cursor: pointer;
            padding: 5px 0; /* Padding for the header content itself */
        }
        .tree-node-header:hover { background-color: #f5f5f5; } /* Hover effect for clickable area */

        /* å±•å¼€/æŠ˜å å›¾æ ‡ */
        .tree-node-toggle {
            display: inline-block;
            width: 16px; /* å›ºå®šå®½åº¦ï¼Œä½¿å›¾æ ‡å¯¹é½ */
            text-align: center;
            cursor: pointer;
            margin-right: 4px;
            transition: transform 0.2s;
            flex-shrink: 0;
            color: #666; /* é»˜è®¤é¢œè‰² */
            font-size: 10px; /* å°ç®­å¤´ */
        }
        /* å±•å¼€æ—¶æ—‹è½¬ç®­å¤´ */
        .tree-node-toggle.expanded {
            transform: rotate(90deg);
        }
        /* å ä½ç¬¦ï¼Œå¦‚æœèŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œä¹Ÿä¿æŒå¯¹é½ */
        .tree-node-toggle.placeholder {
            visibility: hidden; /* ä¿æŒç©ºé—´ä½†ä¸å¯è§ */
        }

        /* æ–‡ä»¶/æ–‡ä»¶å¤¹å›¾æ ‡ */
        .tree-node-icon {
            margin-right: 8px;
            color: #1890ff; /* å›¾æ ‡é¢œè‰² */
            flex-shrink: 0;
            font-size: 14px; /* å›¾æ ‡å¤§å° */
        }

        /* èŠ‚ç‚¹æ–‡æœ¬ */
        .tree-node-text {
            flex-grow: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* èŠ‚ç‚¹çº§åˆ«æ ‡ç­¾ */
        .tree-level-tag {
            font-size: 11px;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 8px;
            line-height: 1;
            vertical-align: middle;
            display: inline-block;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }
        .tree-level-1 { color: #f5222d; background-color: #fff1f0; border: 1px solid #ffa39e; } /* ä¸€çº§ - çº¢è‰² */
        .tree-level-2 { color: #faad14; background-color: #fffbe6; border: 1px solid #ffe58f; } /* äºŒçº§ - æ©™è‰² */
        .tree-level-3 { color: #1890ff; background-color: #e6f7ff; border: 1px solid #91d5ff; } /* ä¸‰çº§ - è“è‰² */

        /* å­èŠ‚ç‚¹å®¹å™¨ */
        .tree-children {
            display: none; /* é»˜è®¤éšè— */
        }
        /* å½“çˆ¶èŠ‚ç‚¹å±•å¼€æ—¶æ˜¾ç¤ºå­èŠ‚ç‚¹ */
        .tree-node-item.expanded > .tree-children {
            display: block;
        }

        /* å•é€‰é€‰ä¸­æ ·å¼ */
        .tree-node-header.selected { background-color: #e6f7ff; color: #1890ff; font-weight: 500; }
        
        /* å¤šé€‰æ¡† */
        .tree-checkbox { 
            width: 14px; height: 14px; border: 1px solid #d9d9d9; border-radius: 2px; margin-right: 8px; 
            display: inline-block; position: relative; flex-shrink: 0;
            vertical-align: middle; /* Align with text */
        }
        .tree-node-header.checked .tree-checkbox { background-color: #1890ff; border-color: #1890ff; }
        .tree-node-header.checked .tree-checkbox::after {
            content: ''; position: absolute; left: 3px; top: 0px; width: 4px; height: 8px; 
            border: solid #fff; border-width: 0 2px 2px 0; transform: rotate(45deg);
        }

        /* å¤šé€‰æ ‡ç­¾ */
        .tag-container { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; padding: 2px 0; }
        .multi-tag {
            background: #f5f5f5; border: 1px solid #e8e8e8; border-radius: 2px; padding: 0 6px; 
            font-size: 12px; line-height: 20px; display: flex; align-items: center;
        }
        .multi-tag-close { margin-left: 4px; cursor: pointer; color: #999; }
        .multi-tag-close:hover { color: #ff4d4f; }
    </style>
</head>
<body>

<!-- Tooltip -->
<div id="global-tooltip"></div>

<input type="file" id="importInput" accept=".xlsx, .xls" style="display:none" onchange="handleImport(this)">

<div class="main-container">
    
    <!-- é¡µç­¾ -->
    <div class="tabs-nav">
        <div class="tab-item active" id="tab-revenue" onclick="switchTab('revenue')">æ”¶å…¥åˆåŒ</div>
        <div class="tab-item" id="tab-cost" onclick="switchTab('cost')">æˆæœ¬åˆåŒ</div>
        <div class="tab-item" id="tab-brokerage" onclick="switchTab('brokerage')">å±…é—´åˆåŒ</div>
    </div>

    <!-- æœç´¢ -->
    <div class="search-panel">
        <!-- è°ƒæ•´ 3ï¼šæ–°å¢å…³è”æ”¶å…¥åˆåŒæ£€ç´¢ï¼Œé»˜è®¤éšè— -->
        <div class="search-item" id="search_assoc_box" style="display:none;">
            <span class="search-label">å…³è”æ”¶å…¥åˆåŒ</span>
            <input type="text" class="ant-input" id="search_assoc" style="width: 180px;" placeholder="æ¨¡ç³Šæ£€ç´¢æ”¶å…¥åˆåŒ">
        </div>

        <div class="search-item">
            <span class="search-label">åˆåŒç¼–å·</span>
            <input type="text" class="ant-input" id="search_no" style="width: 180px;" placeholder="è¯·è¾“å…¥">
        </div>
        <div class="search-item">
            <span class="search-label">åˆåŒåç§°</span>
            <input type="text" class="ant-input" id="search_name" style="width: 180px;" placeholder="è¯·è¾“å…¥">
        </div>
        <div class="search-item">
            <span class="search-label" id="searchLabelName">ç­¾çº¦å®¢æˆ·</span>
            <input type="text" class="ant-input" style="width: 180px;" placeholder="è¯·è¾“å…¥">
        </div>
        <button class="btn btn-primary" onclick="renderTable()">æŸ¥è¯¢</button>
        <button class="btn btn-default" onclick="resetSearch()">é‡ç½®</button>
    </div>

    <!-- æ“ä½œ -->
    <div class="action-panel">
        <button class="btn btn-primary" onclick="openModal('add')">ï¼‹ æ–°å¢åˆåŒ</button>
        <button class="btn btn-default" onclick="document.getElementById('importInput').click()">ğŸ“¥ å¯¼å…¥åˆåŒ</button>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table id="mainTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- æ–°å¢/å˜æ›´/è¯¦æƒ… å¼¹çª— -->
<div class="modal-mask" id="addModal">
    <div class="modal-wrapper">
        <div class="modal-header">
            <span id="modalTitle">åˆåŒä¿¡æ¯</span>
            <span style="cursor: pointer; font-size: 20px;" onclick="closeModal('addModal')">Ã—</span>
        </div>
        <div class="modal-body">
            <form id="contractForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editMode">

                <!-- ç±»å‹é€‰æ‹© -->
                <div class="form-row">
                    <label class="form-label required">åˆåŒç±»å‹</label>
                    <div class="form-input-box">
                        <select class="ant-select" id="contractType" onchange="handleTypeChange()">
                            <option value="revenue">æ”¶å…¥åˆåŒ</option>
                            <option value="cost">æˆæœ¬åˆåŒ</option>
                            <option value="brokerage">å±…é—´åˆåŒ</option>
                        </select>
                    </div>
                </div>

                <!-- ================== A. æ”¶å…¥åˆåŒå­—æ®µ ================== -->
                <div id="section-revenue" class="form-section active">
                    <div class="form-row">
                        <label class="form-label required">åˆåŒåç§°</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-rev" id="rev_cname"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">åˆåŒç¼–å·</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-rev" id="rev_no" placeholder="è¯·è¾“å…¥åˆåŒç¼–å·"></div>
                    </div>

                    <!-- ä¿®æ”¹ï¼šç­¾çº¦å®¢æˆ· (ç»„ç»‡æ ‘å•é€‰) -->
                    <div class="form-row">
                        <label class="form-label required">ç­¾çº¦å®¢æˆ·</label>
                        <div class="form-input-box">
                            <div class="tree-select-wrapper" id="rev_signed_tree_wrapper">
                                <div class="tree-select-input" onclick="toggleTree('rev_signed_tree_dropdown')">
                                    <span id="rev_signed_display" style="color:#999;">è¯·é€‰æ‹©ç­¾çº¦å®¢æˆ·</span>
                                    <input type="hidden" id="rev_signed_val" class="required-rev">
                                </div>
                                <div class="tree-dropdown" id="rev_signed_tree_dropdown">
                                    <!-- æ ‘ç»“æ„ç”±JSç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–°å¢ï¼šæœåŠ¡å®¢æˆ· (ç»„ç»‡æ ‘å¤šé€‰) -->
                    <div class="form-row">
                        <label class="form-label required">æœåŠ¡å®¢æˆ·</label>
                        <div class="form-input-box">
                            <div class="tree-select-wrapper" id="rev_service_tree_wrapper">
                                <div class="tree-select-input" style="height:auto; min-height:32px;" onclick="toggleTree('rev_service_tree_dropdown')">
                                    <div class="tag-container" id="rev_service_display">
                                        <span style="color:#999; padding:2px 0;">è¯·é€‰æ‹©æœåŠ¡å®¢æˆ·</span>
                                    </div>
                                    <input type="hidden" id="rev_service_val" class="required-rev">
                                </div>
                                <div class="tree-dropdown" id="rev_service_tree_dropdown">
                                    <!-- æ ‘ç»“æ„ç”±JSç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label class="form-label required">ç­¾çº¦å”®ç”µå…¬å¸</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-rev" id="rev_company"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">ç­¾çº¦å•ä»·</label>
                        <div class="form-input-box">
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input required-rev" id="rev_price" step="0.01">
                                <span class="suffix-text">å…ƒ/Kwh</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================== B. æˆæœ¬åˆåŒå­—æ®µ ================== -->
                <div id="section-cost" class="form-section">
                    <div class="form-row">
                        <label class="form-label required">å…³è”æ”¶å…¥åˆåŒ</label>
                        <div class="form-input-box">
                            <select class="ant-select required-cost" id="cost_assoc_rev">
                                <option value="">è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">åˆåŒåç§°</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-cost" id="cost_cname"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">åˆåŒç¼–å·</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-cost" id="cost_no" placeholder="è¯·è¾“å…¥åˆåŒç¼–å·"></div>
                    </div>

                    <div class="form-row">
                        <label class="form-label required">ä¾›åº”å•†åç§°</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-cost" id="cost_supplier"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">è”ç³»äºº/ç”µè¯</label>
                        <div class="form-input-box" style="display:flex; gap:10px;">
                            <input type="text" class="ant-input" id="cost_contact" placeholder="è”ç³»äºº">
                            <input type="text" class="ant-input" id="cost_phone" placeholder="è”ç³»ç”µè¯">
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">å¸¸è§„ç”µç­¾çº¦</label>
                        <div class="form-input-box" style="display:flex; gap:10px;">
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input required-cost" id="cost_reg_vol" placeholder="ç”µé‡">
                                <span class="suffix-text">Kwh</span>
                            </div>
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input required-cost" id="cost_reg_price" placeholder="å•ä»·">
                                <span class="suffix-text">å…ƒ/Kwh</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">ç»¿ç”µç­¾çº¦</label>
                        <div class="form-input-box" style="display:flex; gap:10px;">
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input" id="cost_green_vol" placeholder="ç”µé‡">
                                <span class="suffix-text">Kwh</span>
                            </div>
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input" id="cost_green_price" placeholder="å•ä»·">
                                <span class="suffix-text">å…ƒ/Kwh</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ================== C. å±…é—´åˆåŒå­—æ®µ ================== -->
                <div id="section-brokerage" class="form-section">
                    <div class="form-row">
                        <label class="form-label required">å…³è”æ”¶å…¥åˆåŒ</label>
                        <div class="form-input-box">
                            <select class="ant-select required-brok" id="brok_assoc_rev">
                                <option value="">è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">åˆåŒåç§°</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-brok" id="brok_cname"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">åˆåŒç¼–å·</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-brok" id="brok_no" placeholder="è¯·è¾“å…¥åˆåŒç¼–å·"></div>
                    </div>
                    
                    <div class="form-row">
                        <label class="form-label required">å®¢æˆ·åç§°</label>
                        <div class="form-input-box">
                            <div class="cascader-group">
                                <select class="ant-select required-brok" id="brok_l1" onchange="handleL1Change('brok')">
                                    <option value="">è¯·é€‰æ‹©ä¸€çº§å®¢æˆ·</option>
                                    <option value="å¹¿è¥¿æŠ•èµ„é›†å›¢">å¹¿è¥¿æŠ•èµ„é›†å›¢</option>
                                    <option value="å¹¿è¥¿åŒ—éƒ¨æ¹¾æŠ•èµ„é›†å›¢">å¹¿è¥¿åŒ—éƒ¨æ¹¾æŠ•èµ„é›†å›¢</option>
                                    <option value="å¹¿è¥¿äº¤é€šæŠ•èµ„é›†å›¢">å¹¿è¥¿äº¤é€šæŠ•èµ„é›†å›¢</option>
                                </select>
                                <select class="ant-select" id="brok_l2" onchange="handleL2Change('brok')">
                                    <option value="">è¯·é€‰æ‹©äºŒçº§å®¢æˆ·</option>
                                </select>
                                <select class="ant-select" id="brok_l3">
                                    <option value="">è¯·é€‰æ‹©ä¸‰çº§å®¢æˆ·</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <label class="form-label required">å±…é—´äººåç§°</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-brok" id="brok_person"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">æ‰€å±é¡¹ç›®</label>
                        <div class="form-input-box"><input type="text" class="ant-input required-brok" id="brok_project" placeholder="å…³è”é¡¹ç›®åç§°"></div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">è”ç³»äºº/ç”µè¯</label>
                        <div class="form-input-box" style="display:flex; gap:10px;">
                            <input type="text" class="ant-input" id="brok_contact" placeholder="è”ç³»äºº">
                            <input type="text" class="ant-input" id="brok_phone" placeholder="è”ç³»ç”µè¯">
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label required">å±…é—´è¯¦æƒ…</label>
                        <div class="form-input-box" style="display:flex; gap:10px;">
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input required-brok" id="brok_vol" placeholder="é¡¹ç›®ç”µé‡">
                                <span class="suffix-text">Kwh</span>
                            </div>
                            <div class="input-suffix-group">
                                <input type="number" class="ant-input required-brok" id="brok_price" placeholder="å±…é—´å•ä»·">
                                <span class="suffix-text">å…ƒ/Kwh</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === å…¬å…±å­—æ®µ === -->
                <div class="form-row">
                    <label class="form-label required">ç­¾çº¦å‘¨æœŸ</label>
                    <div class="form-input-box">
                         <div class="month-range-editor" id="monthPicker">
                            <div class="range-input-wrapper" onclick="togglePicker(event)">
                                <span class="range-icon">ğŸ“…</span>
                                <input type="text" id="startDisp" placeholder="å¼€å§‹" readonly style="border:none; width:40%; text-align:center;">
                                <span>è‡³</span>
                                <input type="text" id="endDisp" placeholder="ç»“æŸ" readonly style="border:none; width:40%; text-align:center;">
                            </div>
                            <div class="picker-panel" id="pickerPanel">
                                <div class="picker-content">
                                    <div style="text-align:center; padding:5px;">2025å¹´</div>
                                    <div class="month-table" id="year2025"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é™„ä»¶ä¸Šä¼  -->
                <div class="form-row">
                    <label class="form-label">é™„ä»¶</label>
                    <div class="form-input-box">
                        <div class="upload-box" id="uploadArea">
                            <button type="button" class="btn btn-default" onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šä¼ é™„ä»¶</button>
                            <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(this)">
                            <div id="fileList" class="file-list"></div>
                        </div>
                    </div>
                </div>

                <!-- å¤‡æ³¨ -->
                <div class="form-row">
                    <label class="form-label">å¤‡æ³¨</label>
                    <div class="form-input-box">
                        <textarea class="ant-input" rows="5" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"></textarea>
                    </div>
                </div>

                <!-- å˜æ›´è¯´æ˜ -->
                <div class="form-row" id="changeDescRow" style="display:none;">
                    <label class="form-label required">å˜æ›´è¯´æ˜</label>
                    <div class="form-input-box">
                        <textarea class="ant-input" id="changeDesc" rows="5" placeholder="è¯·è¾“å…¥å˜æ›´åŸå› åŠå†…å®¹æ‘˜è¦"></textarea>
                    </div>
                </div>

            </form>
        </div>
        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="modal-footer" id="modalFooter">
            <button class="btn btn-default" onclick="submitForm('draft')">ä¿å­˜</button>
            <button class="btn btn-primary" onclick="submitForm('submit')">æäº¤</button>
        </div>
        <div class="modal-footer" id="viewFooter" style="display:none;">
            <button class="btn btn-primary" onclick="closeModal('addModal')">å…³é—­</button>
        </div>
    </div>
</div>

<!-- å˜æ›´è®°å½• å¼¹çª— -->
<div class="modal-mask" id="historyModal">
    <div class="modal-wrapper wide">
        <div class="modal-header">
            <span>åˆåŒå˜æ›´è®°å½•</span>
            <span style="cursor: pointer; font-size: 20px;" onclick="closeModal('historyModal')">Ã—</span>
        </div>
        <div class="modal-body" style="padding:0;">
            <div class="history-layout">
                <div class="history-list" id="historyList"></div>
                <div class="history-detail" id="historyDetail">
                    <div style="color:#999; text-align:center; margin-top:100px;">è¯·é€‰æ‹©å·¦ä¾§è®°å½•æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('historyModal')">å…³é—­</button>
        </div>
    </div>
</div>

<script>
    // --- æ¨¡æ‹Ÿç»„ç»‡æœºæ„æ ‘æ•°æ® ---
    const ORG_TREE_DATA = [
        { label: 'å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸', children: [
            { label: 'å¹¿è¥¿å¹¿æŠ•èƒ½æºé›†å›¢æœ‰é™å…¬å¸', children: [{ label: 'å¹¿æŠ•åŒ—æµ·å‘ç”µæœ‰é™å…¬å¸' }, { label: 'å¹¿æŠ•æ¥å®¾å‘ç”µæœ‰é™å…¬å¸' }] },
            { label: 'å¹¿è¥¿å¹¿æŠ•é“¶æµ·é“ä¸šæœ‰é™å…¬å¸' }
        ]},
        { label: 'å¹¿è¥¿åŒ—éƒ¨æ¹¾æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸', children: [
            { label: 'å¹¿è¥¿åŒ—æŠ•ä¿¡åˆ›ç§‘æŠ€æŠ•èµ„é›†å›¢', children: [{ label: 'åŒ—æŠ•ä¿¡åˆ›è½¯ä»¶ç ”å‘ä¸­å¿ƒ' }, { label: 'åŒ—æŠ•ä¿¡åˆ›æ•°æ®ä¸­å¿ƒ' }] },
            { label: 'å¹¿è¥¿è·¯æ¡¥é›†å›¢æœ‰é™å…¬å¸' }
        ]},
        { label: 'å¹¿è¥¿äº¤é€šæŠ•èµ„é›†å›¢æœ‰é™å…¬å¸', children: [
            { label: 'å¹¿è¥¿é«˜é€Ÿå…¬è·¯æŠ•èµ„æœ‰é™å…¬å¸', children: [{ label: 'å—å®è¿è¥åˆ†å…¬å¸' }, { label: 'æ¡‚æ—è¿è¥åˆ†å…¬å¸' }] },
            { label: 'å¹¿è¥¿äº¤æŠ•ç‰©æµé›†å›¢æœ‰é™å…¬å¸' }
        ]},
        { label: 'å¹¿è¥¿åŒ—éƒ¨æ¹¾å›½é™…æ¸¯åŠ¡é›†å›¢æœ‰é™å…¬å¸', children: [
            { label: 'å¹¿è¥¿åŒ—æ¸¯å¤§æ•°æ®æœ‰é™å…¬å¸' },
            { label: 'é˜²åŸæ¸¯ç å¤´æœ‰é™å…¬å¸' }
        ]},
        { label: 'å¹¿è¥¿æœºåœºç®¡ç†é›†å›¢æœ‰é™è´£ä»»å…¬å¸' },
        { label: 'å¹¿è¥¿å†œå¦é›†å›¢æœ‰é™è´£ä»»å…¬å¸' },
        { label: 'å¹¿è¥¿ç°ä»£ç‰©æµé›†å›¢æœ‰é™å…¬å¸' }
    ];

    // --- æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ (å¹¿è¥¿å›½ä¼æ•°æ®) ---
    function generateData() {
        const rev = [], cost = [], brok = [];
        const statuses = ['active', 'active', 'active', 'active', 'draft', 'draft', 'expired', 'expired', 'terminated', 'terminated'];
        
        // å¹¿è¥¿å›½ä¼åŠä¸‹å±å•ä½æ¨¡æ‹Ÿ (éƒ¨åˆ†ä¸æ ‘æ•°æ®å¯¹åº”ï¼Œéƒ¨åˆ†ä¸ºè‡ªç”±æ–‡æœ¬)
        const customers = [
            { id: 1, name: 'å¹¿æŠ•åŒ—æµ·å‘ç”µæœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•èƒ½æºé›†å›¢æœ‰é™å…¬å¸/å¹¿æŠ•åŒ—æµ·å‘ç”µæœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•èƒ½æºé›†å›¢æœ‰é™å…¬å¸/å¹¿æŠ•åŒ—æµ·å‘ç”µæœ‰é™å…¬å¸', 'å¹¿è¥¿å¹¿æŠ•é“¶æµ·é“ä¸šæœ‰é™å…¬å¸'] },
            { id: 2, name: 'åŒ—æŠ•ä¿¡åˆ›è½¯ä»¶ç ”å‘ä¸­å¿ƒ', signedPath: 'å¹¿è¥¿åŒ—éƒ¨æ¹¾æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿åŒ—æŠ•ä¿¡åˆ›ç§‘æŠ€æŠ•èµ„é›†å›¢/åŒ—æŠ•ä¿¡åˆ›è½¯ä»¶ç ”å‘ä¸­å¿ƒ', servicePaths: ['å¹¿è¥¿åŒ—éƒ¨æ¹¾æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿åŒ—æŠ•ä¿¡åˆ›ç§‘æŠ€æŠ•èµ„é›†å›¢/åŒ—æŠ•ä¿¡åˆ›è½¯ä»¶ç ”å‘ä¸­å¿ƒ'] },
            { id: 3, name: 'å—å®è¿è¥åˆ†å…¬å¸', signedPath: 'å¹¿è¥¿äº¤é€šæŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿é«˜é€Ÿå…¬è·¯æŠ•èµ„æœ‰é™å…¬å¸/å—å®è¿è¥åˆ†å…¬å¸', servicePaths: ['å¹¿è¥¿äº¤é€šæŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿é«˜é€Ÿå…¬è·¯æŠ•èµ„æœ‰é™å…¬å¸/å—å®è¿è¥åˆ†å…¬å¸', 'å¹¿è¥¿äº¤æŠ•ç‰©æµé›†å›¢æœ‰é™å…¬å¸'] },
            { id: 4, name: 'å¹¿è¥¿åŒ—æ¸¯å¤§æ•°æ®æœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿åŒ—éƒ¨æ¹¾å›½é™…æ¸¯åŠ¡é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿åŒ—æ¸¯å¤§æ•°æ®æœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿åŒ—éƒ¨æ¹¾å›½é™…æ¸¯åŠ¡é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿åŒ—æ¸¯å¤§æ•°æ®æœ‰é™å…¬å¸'] },
            { id: 5, name: 'å¹¿è¥¿æœºåœºç®¡ç†é›†å›¢æœ‰é™è´£ä»»å…¬å¸', signedPath: 'å¹¿è¥¿æœºåœºç®¡ç†é›†å›¢æœ‰é™è´£ä»»å…¬å¸', servicePaths: ['å¹¿è¥¿æœºåœºç®¡ç†é›†å›¢æœ‰é™è´£ä»»å…¬å¸'] },
            { id: 6, name: 'å¹¿è¥¿å†œå¦é›†å›¢æœ‰é™è´£ä»»å…¬å¸', signedPath: 'å¹¿è¥¿å†œå¦é›†å›¢æœ‰é™è´£ä»»å…¬å¸', servicePaths: ['å¹¿è¥¿å†œå¦é›†å›¢æœ‰é™è´£ä»»å…¬å¸'] },
            { id: 7, name: 'å¹¿è¥¿ç°ä»£ç‰©æµé›†å›¢æœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿ç°ä»£ç‰©æµé›†å›¢æœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿ç°ä»£ç‰©æµé›†å›¢æœ‰é™å…¬å¸', 'å¹¿è¥¿äº¤æŠ•ç‰©æµé›†å›¢æœ‰é™å…¬å¸'] },
            { id: 8, name: 'å¹¿æŠ•æ¥å®¾å‘ç”µæœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•èƒ½æºé›†å›¢æœ‰é™å…¬å¸/å¹¿æŠ•æ¥å®¾å‘ç”µæœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•èƒ½æºé›†å›¢æœ‰é™å…¬å¸/å¹¿æŠ•æ¥å®¾å‘ç”µæœ‰é™å…¬å¸'] },
            { id: 9, name: 'é˜²åŸæ¸¯ç å¤´æœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿åŒ—éƒ¨æ¹¾å›½é™…æ¸¯åŠ¡é›†å›¢æœ‰é™å…¬å¸/é˜²åŸæ¸¯ç å¤´æœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿åŒ—éƒ¨æ¹¾å›½é™…æ¸¯åŠ¡é›†å›¢æœ‰é™å…¬å¸/é˜²åŸæ¸¯ç å¤´æœ‰é™å…¬å¸'] },
            { id: 10, name: 'å¹¿æŠ•é“¶æµ·é“ä¸šæœ‰é™å…¬å¸', signedPath: 'å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•é“¶æµ·é“ä¸šæœ‰é™å…¬å¸', servicePaths: ['å¹¿è¥¿æŠ•èµ„é›†å›¢æœ‰é™å…¬å¸/å¹¿è¥¿å¹¿æŠ•é“¶æµ·é“ä¸šæœ‰é™å…¬å¸', 'å¹¿æŠ•åŒ—æµ·å‘ç”µæœ‰é™å…¬å¸'] }
        ];

        // ä¾›åº”å•† (å‘ç”µä¼ä¸š)
        const suppliers = ['åæ¶¦ç”µåŠ›(è´ºå·)æœ‰é™å…¬å¸', 'å›½æŠ•åŒ—éƒ¨æ¹¾å‘ç”µ', 'å¹¿è¥¿æ°´åˆ©ç”µä¸šé›†å›¢', 'å¤§å”æ¡‚å† ç”µåŠ›', 'å—æ–¹ç”µç½‘ç»¼åˆèƒ½æº', 'ä¸­å¹¿æ ¸æ–°èƒ½æº', 'åèƒ½å¹¿è¥¿åˆ†å…¬å¸', 'å›½ç”µæŠ•å¹¿è¥¿å…¬å¸', 'å¹¿è¥¿æ¡‚ä¸œç”µåŠ›', 'ç™¾è‰²ç”µåŠ›'];

        // å±…é—´äºº
        const brokers = ['å¹¿è¥¿èƒ½æ•ˆæŠ€æœ¯æœåŠ¡å…¬å¸', 'å—å®ç»¿èƒ½å’¨è¯¢', 'æ¡‚æ—ç”µåŠ›è®¾è®¡é™¢', 'æŸ³å·èŠ‚èƒ½æœåŠ¡ä¸­å¿ƒ', 'å¹¿è¥¿ç¢³ä¸­å’Œç§‘æŠ€', 'åŒ—æµ·èƒ½æºç®¡ç†å…¬å¸', 'ç‰æ—ç”µåŠ›æœåŠ¡', 'é’¦å·æ¸¯èƒ½å’¨è¯¢', 'æ²³æ± å…‰ä¼ç§‘æŠ€', 'ç™¾è‰²å”®ç”µä»£ç†'];

        for(let i=0; i<10; i++) {
            const idx = i+1;
            const revNo = 'REV2025' + String(idx).padStart(3, '0');
            const costNo = 'COS2025' + String(idx).padStart(3, '0');
            const brokNo = 'BRO2025' + String(idx).padStart(3, '0');
            const status = statuses[i];
            const cust = customers[i]; // ä½¿ç”¨æ–°çš„å®¢æˆ·æ•°æ®ç»“æ„

            // æ”¶å…¥åˆåŒ
            rev.push({
                id: idx, status: status, contractNo: revNo, contractName: `2025å¹´${cust.name}è´­ç”µåˆåŒ`, 
                signedCustomer: cust.name, // ç­¾çº¦å®¢æˆ· (æ˜¾ç¤ºåç§°)
                signedCustomerPath: cust.signedPath, // ç­¾çº¦å®¢æˆ· (å®Œæ•´è·¯å¾„ï¼Œç”¨äºå›æ˜¾æ ‘)
                serviceCustomers: cust.servicePaths.map(path => path.split('/').pop()), // æœåŠ¡å®¢æˆ· (æ˜¾ç¤ºåç§°åˆ—è¡¨)
                serviceCustomersPaths: cust.servicePaths, // æœåŠ¡å®¢æˆ· (å®Œæ•´è·¯å¾„åˆ—è¡¨ï¼Œç”¨äºå›æ˜¾æ ‘)
                company: 'åŒ—æŠ•ä¿¡åˆ›ç§‘æŠ€æœ‰é™å…¬å¸', period: '2025.01-2025.12', volume: 10000+idx*500, price: 340+idx,
                history: i===0 ? [{ date: '2025-02-15 10:30', user: 'å¼ ä¸‰', desc: 'æ ¹æ®å¸‚åœºè°ƒæ•´å•ä»·', diff: [{ field: 'ç­¾çº¦å•ä»·', old: '300.00', new: '341.00' }] }] : []
            });

            // æˆæœ¬åˆåŒ (å…³è”æ”¶å…¥ID)
            cost.push({
                id: idx, linkRevId: idx, 
                status: status, contractNo: costNo, contractName: `2025å¹´${suppliers[i]}è´­ç”µåˆåŒ`, 
                supplier: suppliers[i], 
                contact: 'æç»ç†', phone: '1390000'+idx,
                period: '2025.01-2025.12', regVol: 50000+idx*1000, regPrice: 300+idx, greenVol: 1000+idx*100, greenPrice: 380+idx,
                history: []
            });

            // å±…é—´åˆåŒ (å…³è”æ”¶å…¥ID)
            brok.push({
                id: idx, linkRevId: idx, 
                status: status, contractNo: brokNo, contractName: `${cust.name}é¡¹ç›®å±…é—´æœåŠ¡åˆåŒ`, 
                name: cust.name, // å®¢æˆ·åç§°ï¼Œæ²¿ç”¨æ—§é€»è¾‘
                fullPath: '', // å±…é—´åˆåŒæœªæ”¹åŠ¨ç»„ç»‡æ ‘ï¼Œæ­¤å¤„ç•™ç©ºæˆ–ä¿æŒåŸæ ·
                level: '3çº§', l1: '', // å±…é—´åˆåŒæœªæ”¹åŠ¨ç»„ç»‡æ ‘ï¼Œæ­¤å¤„ç•™ç©ºæˆ–ä¿æŒåŸæ ·
                broker: brokers[i], project: `${cust.name}è´­ç”µé¡¹ç›®`, contact: 'å¼ ä¸‰', phone: '13888888888',
                period: '2025.01-2025.12', vol: 10000+idx*500, price: 5.00+idx*0.1,
                history: []
            });
        }
        return { rev, cost, brok };
    }

    const MOCK = generateData();
    let REVENUE_DATA = MOCK.rev;
    let COST_DATA = MOCK.cost;
    let BROKERAGE_DATA = MOCK.brok;
    
    let currentTab = 'revenue';
    let searchFilter = { linkRevId: null };

    function init() {
        renderTable();
        initMonthPicker();
        bindTooltipEvents();
        initTreeSelects(); // åˆå§‹åŒ–æ ‘å½¢é€‰æ‹©
    }

    // --- é¡µé¢é€»è¾‘ ---
    function switchTab(tab) {
        document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        currentTab = tab;
        
        // æ›´æ–°æœç´¢æ¡†æ ‡ç­¾
        const labelMap = { 'revenue': 'ç­¾çº¦å®¢æˆ·', 'cost': 'ä¾›åº”å•†åç§°', 'brokerage': 'å±…é—´äººåç§°' };
        document.getElementById('searchLabelName').innerText = labelMap[tab];
        
        // å…³è”æ”¶å…¥åˆåŒæ£€ç´¢æ˜¾éš
        document.getElementById('search_assoc_box').style.display = (tab === 'revenue') ? 'none' : 'flex';

        renderTable();
    }

    function jumpToLinked(targetTab, revId, revName) {
        switchTab(targetTab);
        document.getElementById('search_name').value = '';
        searchFilter.linkRevId = revId; 
        renderTable();
        alert(`å·²è·³è½¬è‡³${targetTab==='cost'?'æˆæœ¬':'å±…é—´'}åˆåŒåˆ—è¡¨ï¼Œç­›é€‰å…³è”æ”¶å…¥åˆåŒï¼š${revName}`);
    }

    function resetSearch() {
        document.getElementById('search_no').value = '';
        document.getElementById('search_name').value = '';
        document.getElementById('search_assoc').value = '';
        searchFilter.linkRevId = null;
        renderTable();
    }

    function handleImport(input) {
        if(input.files && input.files[0]) {
            setTimeout(() => { alert(`æ–‡ä»¶ ${input.files[0].name} å¯¼å…¥æˆåŠŸï¼\næ•°æ®å·²æ›´æ–°ã€‚`); input.value = ''; }, 500);
        }
    }

    // --- æ¸²æŸ“è¡¨æ ¼ ---
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHead');
        tbody.innerHTML = '';

        const filterNo = document.getElementById('search_no').value.toLowerCase();
        const filterName = document.getElementById('search_name').value.toLowerCase();
        const filterAssoc = document.getElementById('search_assoc').value.toLowerCase(); // å…³è”æ”¶å…¥æ¨¡ç³Šæœ

        const filterFn = (item) => {
            const matchNo = item.contractNo.toLowerCase().includes(filterNo);
            const matchName = item.contractName.toLowerCase().includes(filterName);
            // å…³è”IDç²¾ç¡®ç­›é€‰
            const matchLink = searchFilter.linkRevId ? item.linkRevId === searchFilter.linkRevId : true;
            // å…³è”æ”¶å…¥åç§°æ¨¡ç³Šç­›é€‰
            let matchAssoc = true;
            if (currentTab !== 'revenue' && filterAssoc) {
                const rev = REVENUE_DATA.find(r => r.id === item.linkRevId);
                matchAssoc = rev && rev.contractName.toLowerCase().includes(filterAssoc);
            }
            return matchNo && matchName && matchLink && matchAssoc;
        };

        if (currentTab === 'revenue') {
            searchFilter.linkRevId = null; 
            // ä¿®æ”¹è¡¨å¤´ï¼šç­¾çº¦å®¢æˆ·ã€æœåŠ¡å®¢æˆ·
            thead.innerHTML = `<tr><th width="50">åºå·</th><th>åˆåŒçŠ¶æ€</th><th>åˆåŒåç§°</th><th>åˆåŒç¼–å·</th><th>ç­¾çº¦å®¢æˆ·</th><th>æœåŠ¡å®¢æˆ·</th><th>ç­¾çº¦å”®ç”µå…¬å¸</th><th>æ”¯å‡ºåˆåŒ</th><th>å±…é—´åˆåŒ</th><th class="align-right">ç­¾çº¦ç”µé‡(Kwh)</th><th class="align-right">ç­¾çº¦å•ä»·(å…ƒ/Kwh)</th><th class="align-center sticky-col">æ“ä½œ</th></tr>`;
            
            REVENUE_DATA.filter(filterFn).forEach((d, i) => {
                const linkedCosts = COST_DATA.filter(c => c.linkRevId === d.id);
                const linkedBroks = BROKERAGE_DATA.filter(b => b.linkRevId === d.id);
                const costTip = linkedCosts.map(c => `${c.contractName} (${c.contractNo})`).join('\n');
                const brokTip = linkedBroks.map(b => `${b.contractName} (${b.contractNo})`).join('\n');
                
                // ç»Ÿè®¡é“¾æ¥
                const costHtml = linkedCosts.length > 0 ? `<span class="count-link" data-tooltip="${costTip}" onclick="jumpToLinked('cost', ${d.id}, '${d.contractName}')">${linkedCosts.length}ä»½</span>` : 'â€”';
                const brokHtml = linkedBroks.length > 0 ? `<span class="count-link" data-tooltip="${brokTip}" onclick="jumpToLinked('brokerage', ${d.id}, '${d.contractName}')">${linkedBroks.length}ä»½</span>` : 'â€”';

                const contractLink = `<a class="contract-link" onclick="openModal('view', ${d.id})">${d.contractName}</a>`;
                
                // æ¸²æŸ“æœåŠ¡å®¢æˆ·åˆ—
                const serviceCustStr = d.serviceCustomers ? d.serviceCustomers.join('ã€') : '';
                const serviceCustHtml = serviceCustStr.length > 20 ? `<span data-tooltip="${serviceCustStr}" class="customer-link">${serviceCustStr.substring(0,20)}...</span>` : serviceCustStr;

                tbody.innerHTML += `<tr><td>${i+1}</td><td>${getStatusTag(d.status)}</td><td>${contractLink}</td><td>${d.contractNo}</td><td>${d.signedCustomer}</td><td>${serviceCustHtml}</td><td>${d.company}</td><td>${costHtml}</td><td>${brokHtml}</td><td class="align-right">${d.volume.toFixed(2)}</td><td class="align-right">${d.price.toFixed(2)}</td><td class="align-center sticky-col">${getOpsButtons(d)}</td></tr>`;
            });

        } else if (currentTab === 'cost') {
            thead.innerHTML = `<tr><th width="50">åºå·</th><th>åˆåŒçŠ¶æ€</th><th>åˆåŒåç§°</th><th>åˆåŒç¼–å·</th><th>å…³è”æ”¶å…¥åˆåŒ</th><th>ä¾›åº”å•†åç§°</th><th>è”ç³»äºº</th><th>è”ç³»ç”µè¯</th><th class="align-right">å¸¸è§„ç”µé‡(Kwh)</th><th class="align-right">å¸¸è§„å•ä»·(å…ƒ/Kwh)</th><th class="align-right">ç»¿ç”µç”µé‡(Kwh)</th><th class="align-right">ç»¿ç”µå•ä»·(å…ƒ/Kwh)</th><th class="align-center sticky-col">æ“ä½œ</th></tr>`;
            
            COST_DATA.filter(filterFn).forEach((d, i) => {
                const contractLink = `<a class="contract-link" onclick="openModal('view', ${d.id})">${d.contractName}</a>`;
                const revContract = REVENUE_DATA.find(r => r.id === d.linkRevId);
                const revLink = revContract ? `<a class="assoc-link" onclick="openModal('view', ${revContract.id}, 'revenue')">${revContract.contractName}</a>` : 'â€”';

                tbody.innerHTML += `<tr><td>${i+1}</td><td>${getStatusTag(d.status)}</td><td>${contractLink}</td><td>${d.contractNo}</td><td>${revLink}</td><td>${d.supplier}</td><td>${d.contact}</td><td>${d.phone}</td><td class="align-right">${d.regVol}</td><td class="align-right">${d.regPrice}</td><td class="align-right">${d.greenVol}</td><td class="align-right">${d.greenPrice}</td><td class="align-center sticky-col">${getOpsButtons(d)}</td></tr>`;
            });

        } else if (currentTab === 'brokerage') {
            thead.innerHTML = `<tr><th width="50">åºå·</th><th>åˆåŒçŠ¶æ€</th><th>åˆåŒåç§°</th><th>åˆåŒç¼–å·</th><th>å…³è”æ”¶å…¥åˆåŒ</th><th>å®¢æˆ·åç§°</th><th>å±…é—´äººåç§°</th><th>æ‰€å±é¡¹ç›®</th><th class="align-right">é¡¹ç›®ç”µé‡(Kwh)</th><th class="align-right">å±…é—´å•ä»·(å…ƒ/Kwh)</th><th class="align-center sticky-col">æ“ä½œ</th></tr>`;
            
            BROKERAGE_DATA.filter(filterFn).forEach((d, i) => {
                const customerHtml = `<span class="customer-link" data-fullpath="${d.fullPath}">${d.name}</span><span class="level-tag">${d.level}</span>`;
                const contractLink = `<a class="contract-link" onclick="openModal('view', ${d.id})">${d.contractName}</a>`;
                const revContract = REVENUE_DATA.find(r => r.id === d.linkRevId);
                const revLink = revContract ? `<a class="assoc-link" onclick="openModal('view', ${revContract.id}, 'revenue')">${revContract.contractName}</a>` : 'â€”';

                tbody.innerHTML += `<tr><td>${i+1}</td><td>${getStatusTag(d.status)}</td><td>${contractLink}</td><td>${d.contractNo}</td><td>${revLink}</td><td>${customerHtml}</td><td>${d.broker}</td><td>${d.project}</td><td class="align-right">${d.vol}</td><td class="align-right">${d.price.toFixed(2)}</td><td class="align-center sticky-col">${getOpsButtons(d)}</td></tr>`;
            });
        }
        bindTooltipEvents();
    }

    function getStatusTag(s) {
        if(s==='active') return '<span class="status-tag st-active">ç”Ÿæ•ˆä¸­</span>';
        if(s==='draft') return '<span class="status-tag st-draft">è‰ç¨¿</span>';
        if(s==='expired') return '<span class="status-tag st-expired">å·²åˆ°æœŸ</span>';
        if(s==='terminated') return '<span class="status-tag st-end">å·²ç»ˆæ­¢</span>';
        return s;
    }

    function getOpsButtons(d) {
        let ops = '';
        if(d.status === 'active') {
            ops += `<button class="btn btn-link" onclick="openModal('change', ${d.id})">å˜æ›´</button>`;
            ops += `<button class="btn btn-link danger">ç»ˆæ­¢</button>`;
        } else if (d.status === 'draft') {
            ops += `<button class="btn btn-link" onclick="openModal('edit', ${d.id})">ç¼–è¾‘</button>`;
            ops += `<button class="btn btn-link danger">åˆ é™¤</button>`;
        } else {
            ops += `<button class="btn btn-link" onclick="openModal('view', ${d.id})">æŸ¥çœ‹</button>`;
        }
        if (d.history && d.history.length > 0) {
            ops += `<button class="btn btn-link" onclick="openHistory(${d.id})">å˜æ›´è®°å½•</button>`;
        }
        return ops;
    }

    // --- æ ‘å½¢é€‰æ‹©å™¨é€»è¾‘ (æ–°å¢åŠå®Œå–„) ---
    let selectedServiceCustomers = []; // å¤šé€‰å­˜å‚¨ (ä»…å­˜å‚¨label)

    function initTreeSelects() {
        // æ¸²æŸ“å•é€‰æ ‘
        renderTree('rev_signed_tree_dropdown', ORG_TREE_DATA, 'single', 'rev_signed');
        // æ¸²æŸ“å¤šé€‰æ ‘
        renderTree('rev_service_tree_dropdown', ORG_TREE_DATA, 'multi', 'rev_service');

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.tree-select-wrapper')) {
                document.querySelectorAll('.tree-dropdown').forEach(el => el.classList.remove('show'));
            }
        });
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®è·¯å¾„è·å–èŠ‚ç‚¹
    function findNodeByPath(data, path) {
        let currentLevel = data;
        const pathParts = path.split('/');
        let foundNode = null;

        for (const part of pathParts) {
            const node = currentLevel.find(n => n.label === part);
            if (node) {
                foundNode = node;
                currentLevel = node.children || [];
            } else {
                foundNode = null;
                break;
            }
        }
        return foundNode;
    }

    // è¾…åŠ©å‡½æ•°ï¼šè·å–èŠ‚ç‚¹å®Œæ•´è·¯å¾„
    function getNodeFullPath(node, parentPath = '') {
        const currentPath = parentPath ? `${parentPath}/${node.label}` : node.label;
        if (!node.children || node.children.length === 0) {
            return currentPath;
        }
        // å¯¹äºçˆ¶èŠ‚ç‚¹ï¼Œè¿”å›å…¶è‡ªèº«çš„è·¯å¾„ï¼Œä¸æ‹¼æ¥å­èŠ‚ç‚¹
        return currentPath;
    }


    function renderTree(containerElement, data, mode, prefix, level=0, parentPath='') {
        // å¦‚æœæ˜¯é¡¶å±‚è°ƒç”¨ï¼ˆcontainerElementæ˜¯dropdownæœ¬èº«ï¼‰ï¼Œåˆ™æ¸…ç©º
        if(typeof containerElement === 'string') { // Means it's an ID, so it's the dropdown container
            const dropdown = document.getElementById(containerElement);
            if (dropdown) dropdown.innerHTML = '';
            containerElement = dropdown; // Reset containerElement to the actual DOM node
        }

        data.forEach(node => {
            const nodePath = getNodeFullPath(node, parentPath); // è·å–å½“å‰èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„
            const nodeWrapper = document.createElement('div'); // åŒ…è£…ä¸€ä¸ªèŠ‚ç‚¹çš„å®¹å™¨
            nodeWrapper.className = 'tree-node-item';

            const headerDiv = document.createElement('div'); // å®é™…æ˜¾ç¤ºå’Œå¯ç‚¹å‡»çš„å¤´éƒ¨
            headerDiv.className = 'tree-node-header';
            headerDiv.style.paddingLeft = (level * 15 + 12) + 'px'; // ç¼©è¿›

            // 1. å±•å¼€/æŠ˜å ç®­å¤´ (å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹)
            if (node.children && node.children.length > 0) {
                const toggleSpan = document.createElement('span');
                toggleSpan.className = 'tree-node-toggle';
                toggleSpan.innerHTML = '&#9658;'; // å³ç®­å¤´
                toggleSpan.onclick = (e) => {
                    e.stopPropagation(); // é˜»æ­¢ç‚¹å‡»ç®­å¤´æ—¶è§¦å‘é€‰æ‹©
                    toggleChildrenVisibility(toggleSpan, nodeWrapper);
                };
                headerDiv.appendChild(toggleSpan);
            } else {
                // å ä½ç¬¦ï¼Œä¿æŒå¯¹é½
                const emptySpan = document.createElement('span');
                emptySpan.className = 'tree-node-toggle placeholder';
                emptySpan.innerHTML = '&#9658;'; // ä½¿ç”¨ç›¸åŒå†…å®¹ï¼Œä½†é€šè¿‡CSSéšè—
                headerDiv.appendChild(emptySpan);
            }

            // 2. å›¾æ ‡ (æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶)
            const iconSpan = document.createElement('span');
            iconSpan.className = 'tree-node-icon';
            iconSpan.innerHTML = (node.children && node.children.length > 0) ? '&#x1F4C1;' : '&#x1F4C4;'; // ğŸ“ æˆ– ğŸ“„
            headerDiv.appendChild(iconSpan);

            // 3. å¤šé€‰æ¡† (ä»…å¯¹å¤šé€‰æ¨¡å¼)
            if (mode === 'multi') {
                const check = document.createElement('span');
                check.className = 'tree-checkbox';
                headerDiv.appendChild(check);
            }

            // 4. èŠ‚ç‚¹æ–‡æœ¬
            const textSpan = document.createElement('span');
            textSpan.className = 'tree-node-text';
            textSpan.innerText = node.label;
            headerDiv.appendChild(textSpan);

            // 5. èŠ‚ç‚¹çº§åˆ«æ ‡ç­¾
            const levelTagSpan = document.createElement('span');
            levelTagSpan.className = 'tree-level-tag ' + (level === 0 ? 'tree-level-1' : (level === 1 ? 'tree-level-2' : 'tree-level-3'));
            levelTagSpan.innerText = level === 0 ? 'ä¸€çº§' : (level === 1 ? 'äºŒçº§' : 'ä¸‰çº§');
            headerDiv.appendChild(levelTagSpan);

            // å°†å®Œæ•´è·¯å¾„å­˜å‚¨åœ¨dataå±æ€§ä¸­ï¼Œä¾¿äºåç»­æŸ¥æ‰¾
            headerDiv.dataset.value = node.label; // å­˜å‚¨å½“å‰èŠ‚ç‚¹åç§°
            headerDiv.dataset.fullPath = nodePath; // å­˜å‚¨å®Œæ•´è·¯å¾„
            
            // ç»‘å®šé€‰æ‹©ç‚¹å‡»äº‹ä»¶åˆ°headerDiv
            headerDiv.onclick = (e) => {
                // ç¡®ä¿ç‚¹å‡»checkboxæ—¶ä¸ä¼šé‡å¤è§¦å‘selection
                if (e.target.classList.contains('tree-checkbox')) return; 
                handleTreeSelect(node.label, nodePath, mode, prefix, headerDiv);
            };

            nodeWrapper.appendChild(headerDiv);

            // 6. å­èŠ‚ç‚¹å®¹å™¨ (å¦‚æœå­˜åœ¨å­èŠ‚ç‚¹)
            if (node.children && node.children.length > 0) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children'; // é»˜è®¤éšè—é€šè¿‡CSS
                nodeWrapper.appendChild(childrenContainer);
                // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹ï¼Œå¹¶ä¼ é€’å½“å‰èŠ‚ç‚¹çš„å®Œæ•´è·¯å¾„ä½œä¸ºçˆ¶è·¯å¾„
                renderTree(childrenContainer, node.children, mode, prefix, level + 1, nodePath);
            }

            containerElement.appendChild(nodeWrapper);
        });
    }

    // å±•å¼€/æŠ˜å å­èŠ‚ç‚¹
    function toggleChildrenVisibility(toggleSpan, nodeWrapper) {
        nodeWrapper.classList.toggle('expanded');
        toggleSpan.classList.toggle('expanded'); // æ—‹è½¬ç®­å¤´
        toggleSpan.innerHTML = nodeWrapper.classList.contains('expanded') ? '&#9660;' : '&#9658;'; // æ”¹å˜ç®­å¤´å›¾æ ‡
    }

    function toggleTree(id) {
        // å¦‚æœç¦ç”¨åˆ™ä¸æ‰“å¼€ (æŸ¥çœ‹æ¨¡å¼)
        const dropdownElement = document.getElementById(id);
        if (!dropdownElement) return;

        const wrapper = dropdownElement.parentElement; // tree-select-wrapper
        const input = wrapper.querySelector('.tree-select-input');
        if (input.classList.contains('disabled') || input.style.pointerEvents === 'none') return;

        document.querySelectorAll('.tree-dropdown').forEach(el => {
            if(el.id !== id) el.classList.remove('show');
        });
        dropdownElement.classList.toggle('show');
    }

    function handleTreeSelect(label, fullPath, mode, prefix, domElement) {
        if(mode === 'single') {
            document.getElementById(prefix + '_val').value = fullPath; // å­˜å‚¨å®Œæ•´è·¯å¾„
            document.getElementById(prefix + '_display').innerText = label; // æ˜¾ç¤ºåç§°
            document.getElementById(prefix + '_display').style.color = '#333';
            
            // é«˜äº®å¤„ç†
            const container = document.getElementById(prefix + '_tree_dropdown');
            container.querySelectorAll('.tree-node-header').forEach(n => n.classList.remove('selected'));
            domElement.classList.add('selected');
            container.classList.remove('show'); // å…³é—­ä¸‹æ‹‰
        } else {
            // å¤šé€‰é€»è¾‘
            domElement.classList.toggle('checked');
            const idx = selectedServiceCustomers.indexOf(fullPath); // å¤šé€‰å­˜å‚¨å®Œæ•´è·¯å¾„
            if(domElement.classList.contains('checked')) {
                if(idx === -1) selectedServiceCustomers.push(fullPath);
            } else {
                if(idx > -1) selectedServiceCustomers.splice(idx, 1);
            }
            updateMultiSelectDisplay(prefix);
        }
    }

    function updateMultiSelectDisplay(prefix) {
        const display = document.getElementById(prefix + '_display');
        const hidden = document.getElementById(prefix + '_val');
        
        hidden.value = JSON.stringify(selectedServiceCustomers);
        display.innerHTML = '';
        
        if(selectedServiceCustomers.length === 0) {
            display.innerHTML = '<span style="color:#999; padding:2px 0;">è¯·é€‰æ‹©æœåŠ¡å®¢æˆ·</span>';
        } else {
            // ä»…æ˜¾ç¤ºæœ€ç»ˆèŠ‚ç‚¹åç§°
            selectedServiceCustomers.forEach(fullPath => {
                const label = fullPath.split('/').pop(); // è·å–è·¯å¾„çš„æœ€åä¸€éƒ¨åˆ†ä½œä¸ºæ˜¾ç¤ºåç§°
                const tag = document.createElement('div');
                tag.className = 'multi-tag';
                tag.innerHTML = `${label} <span class="multi-tag-close" data-full-path="${fullPath}" onclick="removeMultiTag(this.dataset.fullPath, '${prefix}', event)">Ã—</span>`;
                display.appendChild(tag);
            });
        }
    }

    function removeMultiTag(fullPath, prefix, e) {
        e.stopPropagation();
        const idx = selectedServiceCustomers.indexOf(fullPath);
        if(idx > -1) selectedServiceCustomers.splice(idx, 1);
        
        // æ›´æ–°æ ‘ä¸­çš„é€‰ä¸­çŠ¶æ€
        const container = document.getElementById(prefix + '_tree_dropdown');
        const nodes = container.querySelectorAll('.tree-node-header');
        nodes.forEach(node => {
            if(node.dataset.fullPath === fullPath) node.classList.remove('checked');
        });
        
        updateMultiSelectDisplay(prefix);
    }
    
    // æ¸…ç©ºæ ‘é€‰æ‹©å™¨
    function clearTreeSelection(prefix, mode) {
        if (mode === 'single') {
            document.getElementById(prefix + '_val').value = '';
            document.getElementById(prefix + '_display').innerText = 'è¯·é€‰æ‹©ç­¾çº¦å®¢æˆ·';
            document.getElementById(prefix + '_display').style.color = '#999';
            document.getElementById(prefix + '_tree_dropdown').querySelectorAll('.tree-node-header').forEach(n => n.classList.remove('selected'));
        } else {
            selectedServiceCustomers = [];
            updateMultiSelectDisplay(prefix);
            document.getElementById(prefix + '_tree_dropdown').querySelectorAll('.tree-node-header').forEach(n => n.classList.remove('checked'));
        }
        // é‡ç½®æ‰€æœ‰å±•å¼€çŠ¶æ€
        document.getElementById(prefix + '_tree_dropdown').querySelectorAll('.tree-node-item').forEach(item => {
            item.classList.remove('expanded');
            const toggle = item.querySelector('.tree-node-toggle');
            if(toggle && !toggle.classList.contains('placeholder')) {
                toggle.classList.remove('expanded');
                toggle.innerHTML = '&#9658;'; // æ¢å¤å³ç®­å¤´
            }
        });
    }
    
    // è®¾ç½®æ ‘é€‰ä¸­å€¼ (ç¼–è¾‘/æŸ¥çœ‹æ—¶)
    function setTreeValue(prefix, paths, mode) {
        // paths å¯ä»¥æ˜¯å•ä¸ªè·¯å¾„å­—ç¬¦ä¸² (å•é€‰) æˆ–è·¯å¾„æ•°ç»„ (å¤šé€‰)
        const container = document.getElementById(prefix + '_tree_dropdown');
        if (!container) return;

        // å…ˆæ¸…ç©ºæ‰€æœ‰é€‰ä¸­/å‹¾é€‰çŠ¶æ€
        container.querySelectorAll('.tree-node-header').forEach(n => {
            n.classList.remove('selected', 'checked');
        });
        container.querySelectorAll('.tree-node-item').forEach(item => {
            item.classList.remove('expanded');
            const toggle = item.querySelector('.tree-node-toggle');
            if(toggle && !toggle.classList.contains('placeholder')) {
                toggle.classList.remove('expanded');
                toggle.innerHTML = '&#9658;'; // æ¢å¤å³ç®­å¤´
            }
        });

        if (mode === 'single') {
            const fullPath = paths;
            document.getElementById(prefix + '_val').value = fullPath || '';
            document.getElementById(prefix + '_display').innerText = fullPath ? fullPath.split('/').pop() : 'è¯·é€‰æ‹©ç­¾çº¦å®¢æˆ·';
            document.getElementById(prefix + '_display').style.color = fullPath ? '#333' : '#999';
            
            if (fullPath) {
                const selectedHeader = container.querySelector(`[data-full-path="${fullPath}"]`);
                if (selectedHeader) {
                    selectedHeader.classList.add('selected');
                    // å±•å¼€æ‰€æœ‰çˆ¶çº§èŠ‚ç‚¹
                    let currentPathParts = fullPath.split('/');
                    while (currentPathParts.length > 1) {
                        currentPathParts.pop();
                        const parentPath = currentPathParts.join('/');
                        const parentHeader = container.querySelector(`[data-full-path="${parentPath}"]`);
                        if (parentHeader) {
                            const parentItem = parentHeader.closest('.tree-node-item');
                            if (parentItem && !parentItem.classList.contains('expanded')) {
                                parentItem.classList.add('expanded');
                                const toggle = parentHeader.querySelector('.tree-node-toggle');
                                if (toggle) {
                                    toggle.classList.add('expanded');
                                    toggle.innerHTML = '&#9660;';
                                }
                            }
                        }
                    }
                }
            }
        } else { // multi-select
            selectedServiceCustomers = Array.isArray(paths) ? [...paths] : [];
            updateMultiSelectDisplay(prefix); // æ›´æ–°æ˜¾ç¤ºæ ‡ç­¾
            
            selectedServiceCustomers.forEach(fullPath => {
                const checkedHeader = container.querySelector(`[data-full-path="${fullPath}"]`);
                if (checkedHeader) {
                    checkedHeader.classList.add('checked');
                    // å±•å¼€æ‰€æœ‰çˆ¶çº§èŠ‚ç‚¹
                    let currentPathParts = fullPath.split('/');
                    while (currentPathParts.length > 1) {
                        currentPathParts.pop();
                        const parentPath = currentPathParts.join('/');
                        const parentHeader = container.querySelector(`[data-full-path="${parentPath}"]`);
                        if (parentHeader) {
                            const parentItem = parentHeader.closest('.tree-node-item');
                            if (parentItem && !parentItem.classList.contains('expanded')) {
                                parentItem.classList.add('expanded');
                                const toggle = parentHeader.querySelector('.tree-node-toggle');
                                if (toggle) {
                                    toggle.classList.add('expanded');
                                    toggle.innerHTML = '&#9660;';
                                }
                            }
                        }
                    }
                }
            });
        }
    }


    // --- å¼¹çª—é€»è¾‘ ---
    function openModal(mode, id, forcedType) {
        document.getElementById('addModal').classList.add('show');
        document.getElementById('contractForm').reset();
        document.getElementById('fileList').innerHTML = ''; 
        document.getElementById('editMode').value = mode;
        
        // é‡ç½®æ ‘é€‰æ‹©å™¨
        clearTreeSelection('rev_signed', 'single');
        clearTreeSelection('rev_service', 'multi');
        
        let title = '';
        if(mode==='add') title='æ–°å¢åˆåŒ';
        else if(mode==='edit') title='ç¼–è¾‘åˆåŒ';
        else if(mode==='change') title='åˆåŒå˜æ›´';
        else if(mode==='view') title='åˆåŒè¯¦æƒ…';
        document.getElementById('modalTitle').innerText = title;

        document.getElementById('changeDescRow').style.display = (mode === 'change') ? 'flex' : 'none';
        
        // æŒ‰é’®æ˜¾ç¤º
        if(mode === 'view') {
            document.getElementById('modalFooter').style.display = 'none';
            document.getElementById('viewFooter').style.display = 'block';
            document.getElementById('uploadArea').style.pointerEvents = 'none';
            document.getElementById('uploadArea').querySelector('button').style.display = 'none';
        } else {
            document.getElementById('modalFooter').style.display = 'block';
            document.getElementById('viewFooter').style.display = 'none';
            document.getElementById('uploadArea').style.pointerEvents = 'auto';
            document.getElementById('uploadArea').querySelector('button').style.display = 'inline-block';
        }

        const typeSel = document.getElementById('contractType');
        typeSel.disabled = (mode !== 'add'); 
        
        // æ”¯æŒè·¨ç±»å‹æŸ¥çœ‹
        const targetType = forcedType || currentTab;
        typeSel.value = targetType; 
        
        handleTypeChange();
        loadRevenueContracts();

        if (id && mode !== 'add') populateChangeData(id, targetType);
        else if (mode === 'add') enableAllFields();

        if (mode === 'view') disableAllFields();
    }

    function loadRevenueContracts() {
        const costSelect = document.getElementById('cost_assoc_rev');
        const brokSelect = document.getElementById('brok_assoc_rev');
        costSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ</option>';
        brokSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ</option>';
        REVENUE_DATA.forEach(r => {
            const opt = new Option(r.contractName, r.id);
            costSelect.add(opt.cloneNode(true));
            brokSelect.add(opt);
        });
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    function handleTypeChange() {
        const type = document.getElementById('contractType').value;
        document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`section-${type}`).classList.add('active');
    }

    function populateChangeData(id, type) {
        const mode = document.getElementById('editMode').value;
        if (mode !== 'view') enableAllFields();

        let data;
        if (type === 'revenue') {
            data = REVENUE_DATA.find(d => d.id === id);
            // å˜æ›´æ§åˆ¶ï¼šç¦ç”¨å…³é”®å­—æ®µ
            if(mode === 'change') {
                // ç¦ç”¨æ ‘é€‰æ‹©å™¨
                disableTreeInput('rev_signed');
            }
            if(data) {
                document.getElementById('rev_no').value = data.contractNo;
                document.getElementById('rev_cname').value = data.contractName;
                document.getElementById('rev_company').value = data.company;
                document.getElementById('rev_price').value = data.price;
                // è®¾ç½®æ ‘é€‰æ‹©å™¨å€¼
                setTreeValue('rev_signed', data.signedCustomerPath, 'single'); // å›æ˜¾å®Œæ•´è·¯å¾„
                setTreeValue('rev_service', data.serviceCustomersPaths, 'multi'); // å›æ˜¾å®Œæ•´è·¯å¾„æ•°ç»„
            }
        } else if (type === 'cost') {
            data = COST_DATA.find(d => d.id === id);
            if(mode === 'change') disableField('cost_supplier');
            if(data) {
                document.getElementById('cost_no').value = data.contractNo;
                document.getElementById('cost_cname').value = data.contractName;
                document.getElementById('cost_supplier').value = data.supplier;
                document.getElementById('cost_contact').value = data.contact;
                document.getElementById('cost_phone').value = data.phone;
                document.getElementById('cost_reg_vol').value = data.regVol;
                document.getElementById('cost_reg_price').value = data.regPrice;
                document.getElementById('cost_green_vol').value = data.greenVol;
                document.getElementById('cost_green_price').value = data.greenPrice;
                document.getElementById('cost_assoc_rev').value = data.linkRevId;
            }
        } else if (type === 'brokerage') {
            data = BROKERAGE_DATA.find(d => d.id === id);
            if(mode === 'change') ['brok_l1', 'brok_l2', 'brok_l3', 'brok_project'].forEach(fid => disableField(fid));
            if(data) {
                document.getElementById('brok_no').value = data.contractNo;
                document.getElementById('brok_cname').value = data.contractName;
                document.getElementById('brok_person').value = data.broker;
                document.getElementById('brok_project').value = data.project;
                document.getElementById('brok_contact').value = data.contact;
                document.getElementById('brok_phone').value = data.phone;
                document.getElementById('brok_vol').value = data.vol;
                document.getElementById('brok_price').value = data.price;
                document.getElementById('brok_assoc_rev').value = data.linkRevId;
            }
        }
        if(data && data.period) {
            const [s, e] = data.period.split('-');
            document.getElementById('startDisp').value = s;
            document.getElementById('endDisp').value = e;
        }
    }

    function disableField(id) { const el = document.getElementById(id); if(el) { el.disabled = true; el.style.backgroundColor = '#f5f5f5'; } }
    
    function disableTreeInput(prefix) {
        const wrapper = document.getElementById(prefix + '_tree_wrapper');
        const input = wrapper.querySelector('.tree-select-input');
        input.classList.add('disabled');
        input.style.pointerEvents = 'none';
        // ç§»é™¤æ ‡ç­¾å…³é—­æŒ‰é’®
        wrapper.querySelectorAll('.multi-tag-close').forEach(el => el.style.display = 'none');
    }
    
    function enableAllFields() { 
        document.querySelectorAll('input, select, textarea').forEach(el => { 
            if(el.id!=='contractType') { el.disabled = false; el.style.backgroundColor = '#fff'; } 
        }); 
        // å¯ç”¨æ ‘é€‰æ‹©
        document.querySelectorAll('.tree-select-input').forEach(el => {
            el.classList.remove('disabled');
            el.style.pointerEvents = 'auto';
        });
        document.querySelectorAll('.multi-tag-close').forEach(el => el.style.display = 'inline-block');
    }
    
    function disableAllFields() { 
        document.querySelectorAll('input, select, textarea').forEach(el => { el.disabled = true; el.style.backgroundColor = '#f5f5f5'; }); 
        // ç¦ç”¨æ ‘é€‰æ‹©
        document.querySelectorAll('.tree-select-input').forEach(el => {
            el.classList.add('disabled');
            el.style.pointerEvents = 'none';
        });
        document.querySelectorAll('.multi-tag-close').forEach(el => el.style.display = 'none');
    }

    function handleFileUpload(input) {
        if(input.files[0]) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>ğŸ“„ ${input.files[0].name}</span><span class="file-remove" onclick="this.parentElement.remove()">åˆ é™¤</span>`;
            document.getElementById('fileList').appendChild(div);
        }
    }

    function submitForm(action) {
        if(action === 'draft') { alert('å·²ä¿å­˜'); closeModal('addModal'); return; }
        const mode = document.getElementById('editMode').value;
        const type = document.getElementById('contractType').value;

        // æ ¡éªŒé€»è¾‘
        if(type === 'revenue') {
             if(!document.getElementById('rev_signed_val').value) { alert('è¯·é€‰æ‹©ç­¾çº¦å®¢æˆ·'); return; }
             if(selectedServiceCustomers.length === 0) { alert('è¯·é€‰æ‹©æœåŠ¡å®¢æˆ·'); return; }
        }

        if (type === 'cost' && !document.getElementById('cost_assoc_rev').value) { alert('è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ'); return; }
        if (type === 'brokerage' && !document.getElementById('brok_assoc_rev').value) { alert('è¯·é€‰æ‹©å…³è”çš„æ”¶å…¥åˆåŒ'); return; }

        if(mode === 'change' && !document.getElementById('changeDesc').value.trim()) { alert('è¯·å¡«å†™å˜æ›´è¯´æ˜'); return; }
        alert(mode === 'change' ? 'å˜æ›´å·²æäº¤' : 'æäº¤æˆåŠŸ');
        closeModal('addModal');
    }

    function openHistory(id) {
        let data;
        if(currentTab === 'revenue') data = REVENUE_DATA.find(d => d.id === id);
        else if(currentTab === 'cost') data = COST_DATA.find(d => d.id === id);
        else data = BROKERAGE_DATA.find(d => d.id === id);
        
        if (!data || !data.history) return;

        const listEl = document.getElementById('historyList');
        listEl.innerHTML = '';
        data.history.forEach(h => {
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<div class="meta">${h.date} | ${h.user}</div><div class="desc">${h.desc}</div>`;
            item.onclick = () => { document.querySelectorAll('.history-item').forEach(i=>i.classList.remove('active')); item.classList.add('active'); renderDetail(h); };
            listEl.appendChild(item);
        });
        document.getElementById('historyDetail').innerHTML = '<div style="color:#999;text-align:center;margin-top:50px;">è¯·é€‰æ‹©è®°å½•</div>';
        document.getElementById('historyModal').classList.add('show');
    }

    function renderDetail(h) {
        let rows = '';
        if(h.diff) h.diff.forEach(d => rows += `<tr><td>${d.field}</td><td class="diff-old">${d.old}</td><td class="diff-new">${d.new}</td></tr>`);
        document.getElementById('historyDetail').innerHTML = `<div style="margin-bottom:15px;"><strong>è¯´æ˜ï¼š</strong>${h.desc}</div><table class="diff-table"><thead><tr><th>å­—æ®µ</th><th>å˜æ›´å‰</th><th>å˜æ›´å</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function bindTooltipEvents() {
        const tip = document.getElementById('global-tooltip');
        document.querySelectorAll('.customer-link, .count-link').forEach(el => {
            el.addEventListener('mouseenter', e => { 
                const text = el.dataset.fullpath || el.dataset.tooltip;
                if(text) { tip.innerText = text; tip.style.display='block'; tip.style.left=(e.pageX+10)+'px'; tip.style.top=(e.pageY+10)+'px'; }
            });
            el.addEventListener('mousemove', e => { tip.style.left=(e.pageX+10)+'px'; tip.style.top=(e.pageY+10)+'px'; });
            el.addEventListener('mouseleave', () => tip.style.display='none');
        });
    }

    function handleL1Change(prefix) {
        const l2 = document.getElementById(`${prefix}_l2`);
        l2.innerHTML = '<option value="">è¯·é€‰æ‹©äºŒçº§å®¢æˆ·</option>';
        l2.add(new Option('è·¯æ¡¥å»ºè®¾', 's1'));
    }
    function handleL2Change(prefix) {
        const l3 = document.getElementById(`${prefix}_l3`);
        l3.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸‰çº§å®¢æˆ·</option>';
        l3.add(new Option('ä¸€åˆ†å…¬å¸', 'ss1'));
    }

    function initMonthPicker() {
        const p = document.getElementById('year2025');
        if(p && p.childElementCount===0) {
            for(let i=1;i<=12;i++) {
                const d = document.createElement('div'); d.className='month-cell'; d.innerText=i+'æœˆ';
                d.onclick = (e) => { e.stopPropagation(); document.getElementById('startDisp').value='2025-'+(i<10?'0'+i:i); document.getElementById('pickerPanel').style.display='none'; }
                p.appendChild(d);
            }
        }
    }
    function togglePicker(e) {
        e.stopPropagation();
        const p = document.getElementById('pickerPanel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }
    document.addEventListener('click', e => { if(!document.getElementById('monthPicker').contains(e.target)) document.getElementById('pickerPanel').style.display='none'; });

    init();
</script>
</body>
</html>